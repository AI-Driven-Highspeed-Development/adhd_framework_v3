# DREAM v4.04 â€” Unified Planning System Specification

**Version:** 4.04  
**Status:** âœ… Authoritative â€” supersedes v4.03  
**Updated:** February 2026

---

## TL;DR

**DREAM** (Decomposition Rules for Engineering Atomic Modules) is a protocol for breaking complex work into atomic, parallelizable units that AI agents execute independently. It defines **how to assess complexity** (8-slot magnitude routing), **how to structure plans** (filesystem hierarchy with `_overview.md` convention), and **how agents coordinate** (sibling firewall + MANAGER/WORKER lifecycle). Metadata lives in `_overview.md` frontmatter â€” no YAML sidecar files.

**What changed from v4.03:** Cross-plan dependency graph (`depends_on:`/`blocks:` frontmatter), plan invalidation protocol (`invalidated_by:` + `âœ… [DONE:invalidated-by:PP08]`), Module Index enforcement gate, knowledge-gap formalization (`knowledge_gaps:` frontmatter), `dream_mcp` promoted to P0 walking skeleton (3 commands), State Delta cap (20 entries + archive), `_completed/` quarterly sub-grouping (`YYYY-QN/`), `_tree.md` on-demand generation, binary priority field (`normal | emergency`), Module History auto-generation.

---

## What's New in v4.04

> **v4.04** â€” Changelog from v4.03. All items originate from the [v4.03 stress test report](DREAM_v4.03_stress_test_report.md) (MedFlow 18-month analysis, 3-agent consensus).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v4.04 THEME: From recording engine to prediction engine.                   â”‚
â”‚                                                                              â”‚
â”‚  v4.03 tracked WHAT HAPPENED. v4.04 adds cross-plan causal awareness:       â”‚
â”‚  dependency graphs, invalidation propagation, knowledge-gap aggregation,    â”‚
â”‚  and tooling (dream_mcp) that makes conventions self-enforcing.             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| # | Change | Priority | Section |
|---|--------|----------|---------|
| 1 | **`dream_mcp` promoted to P0** â€” walking skeleton with `dream status`, `dream tree`, `dream stale`. P1 adds `dream validate`, `dream impact`, `dream history`, `dream archive` | P0 | [Â§2.14](#214-dream_mcp--enforcement-module) |
| 2 | **Plan invalidation protocol** â€” `invalidated_by:` frontmatter in victim plan + `âœ… [DONE:invalidated-by:PP08]` status variant. Causing plan reports at closure; parent writes to victim (sibling firewall). `dream validate` as safety net | P0 | [Â§1.10](#110-status-syntax), [Â§2.11](#211-plan-closure--gates--procedures) |
| 3 | **Module Index enforcement gate** â€” phase introducing a new module CANNOT mark âœ… DONE until module registered in root Module Index | P0 | [Â§2.11](#211-plan-closure--gates--procedures) |
| 4 | **Cross-plan dependency graph** â€” `depends_on:` / `blocks:` plan-level frontmatter (optional). `dream impact {plan_id}` for DAG walk. Orthogonal to `ğŸš§ [BLOCKED:reason]` | P1 | [Â§1.14](#114-_overviewmd-convention) |
| 5 | **Module History** â€” auto-generated by `dream history {module}` from State Delta entries. Never hand-maintained | P1 | [Â§1.14](#114-_overviewmd-convention) |
| 6 | **Knowledge-gap formalization** â€” `knowledge_gaps:` string array in frontmatter (source of truth). `âš ï¸ [KNOWLEDGE GAP]` remains valid as inline prose. `dream status --gaps` aggregates | P1 | [Â§1.16](#116-knowledge-gap-annotation) |
| 7 | **State Delta cap** â€” 20 most recent entries in root `_overview.md`. Overflow archived to `_state_deltas_archive.md` (generated, never hand-maintained) | P1 | [Â§1.14](#114-_overviewmd-convention) |
| 8 | **Priority field** â€” binary `normal | emergency`. Default = `normal` (omit-when-default). `emergency` plans set `blocks:` on resource-sharing plans | P2 | [Â§1.14](#114-_overviewmd-convention) |
| 9 | **`_completed/` quarterly sub-grouping** â€” `YYYY-QN/` convention. `dream archive PP13` handles the move | P2 | [Â§2.11](#211-plan-closure--gates--procedures) |
| 10 | **`_tree.md` on-demand** â€” generated by `dream tree`, header `<!-- GENERATED â€” run 'dream tree' to refresh -->`. No static maintenance | P2 | [Root-Level Infrastructure Files](#root-level-infrastructure-files) |

---

## Table of Contents

1. [Quick Reference Card](#quick-reference-card)
2. [Folder Structure â€” The Main Event](#folder-structure--the-main-event)
3. [How Variables Shape the Structure](#how-variables-shape-the-structure)
4. [Chapter 1 â€” Author](#chapter-1--author)
5. [Chapter 2 â€” Execute & Verify](#chapter-2--execute--verify)
6. [Templates Reference](#templates-reference)
7. [Anti-Patterns](#anti-patterns)
8. [Deprecated (v4.03 â†’ v4.04)](#deprecated-v403--v404)
9. [Implementation Notes (Carry Forward)](#implementation-notes-carry-forward)

---

## Quick Reference Card

| Concept | Rule |
|---------|------|
| **Plan** | Directory with `_overview.md` â€” decomposable, has children |
| **Task** | Single `.md` file â€” leaf, directly executable |
| **Bridge** | Plan = dir, Task = file. That's the only two primitives |
| **Metadata** | YAML frontmatter in `_overview.md` (name, magnitude, status, origin, timestamps, dependencies, knowledge gaps) |
| **Status markers** | â³`[TODO]` Â· ğŸ”„`[WIP]` Â· âœ…`[DONE]` Â· âœ…`[DONE:invalidated-by:XXnn]` Â· ğŸš§`[BLOCKED:reason]` Â· ğŸš«`[CUT]` |
| **Difficulty labels** | `[KNOWN]` Â· `[EXPERIMENTAL]` Â· `[RESEARCH]` (never in P0) |
| **Magnitudes** | Trivial(1) Â· Light(2) Â· Standard(3) Â· Heavy(5) Â· Epic(8) â€” slot MAXIMUMS |
| **Tiers** | Simple (â‰¤2 features, no APIs) Â· Blueprint (â‰¥3 features OR cross-module OR external APIs) |
| **Plan types** | System Plan (architecture + features) Â· Procedure Plan (workflow + steps) |
| **Plan folder prefix** | `SP01_` (System Plan) Â· `PP01_` (Procedure Plan) â€” creation-order number, IMMUTABLE |
| **Levels** | L0â€“LN optional communication aids. L0=plan, L1=sub-plan covers 95% |
| **Sibling firewall** | Siblings **NEVER** read/write each other's content. Coordinate through parent only |
| **MANAGER** | DECOMPOSE â†’ DELEGATE â†’ INTEGRATE â†’ REPORT |
| **WORKER** | VALIDATE â†’ IMPLEMENT â†’ VERIFY â†’ REPORT |
| **Max parallel agents** | 5 |
| **P0 hard limits** | Max 5 tasks, `[KNOWN]` only, â‰¤5 slots |
| **Walking skeleton** | Opt-in â€” required only when cross-boundary, external API, or 3+ module flow |
| **Human authority** | Human decides WHETHER to plan. DREAM decides the FORMAT |
| **Omit, don't N/A** | Optional files don't exist on disk â€” not filled with "N/A" |
| **Timestamp precision** | Human-authored: `YYYY-MM-DD`. Machine-authored (`dream_mcp`): ISO 8601 `YYYY-MM-DDTHH:MM:SS` |
| **Plan closure gate** | State Delta + Module Index registration required â€” plan CANNOT mark âœ… DONE without them |
| **Archival** | âœ… DONE / ğŸš« CUT plans move to `_completed/YYYY-QN/` |
| **Tiebreaker** | Triggered by existing plan + modifies existing code â†’ Procedure Plan |
| **Decision recording** | Decisions that create/modify/cut plans MUST be recorded in exploration docs |
| **Dependencies** | `depends_on:` / `blocks:` plan-level frontmatter (optional). `dream impact` for DAG walk |
| **Priority** | `normal` (default, omit) Â· `emergency` (supersedes in-progress plans) |
| **Knowledge gaps** | `knowledge_gaps:` frontmatter array (source of truth). `dream status --gaps` aggregates |
| **Invalidation** | `invalidated_by:` in victim plan frontmatter. Caused at closure, written by parent/orchestrator |
| **State Delta cap** | 20 entries in root `_overview.md`. Overflow â†’ `_state_deltas_archive.md` |
| **Module History** | Auto-generated by `dream history {module}`. Never hand-maintained |
| **`dream_mcp`** | P0: `dream status`, `dream tree`, `dream stale`. P1: `dream validate`, `dream impact`, `dream history`, `dream archive` |

### Slot System â€” 8-Slot Visual Scale

Each slot â‰ˆ 1 hour AI-agent time. Values are **MAXIMUMS** â€” actual work can be lower.

```
Trivial   â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡  max 1 slot
Light     â– â– â–¡â–¡â–¡â–¡â–¡â–¡  max 2 slots
Standard  â– â– â– â–¡â–¡â–¡â–¡â–¡  max 3 slots
Heavy     â– â– â– â– â– â–¡â–¡â–¡  max 5 slots
Epic      â– â– â– â– â– â– â– â–   max 8 slots (MUST decompose)
```

| Magnitude | Max Slots | Action | AI-Agent Time |
|-----------|-----------|--------|---------------|
| **Trivial** | 1 | Execute immediately | â‰¤1 hour |
| **Light** | 2 | Execute directly | â‰¤2 hours |
| **Standard** | 3 | Decompose if â‰¥3 subtasks | â‰¤3 hours |
| **Heavy** | 5 | **SHOULD** decompose | â‰¤5 hours |
| **Epic** | 8 | **MUST** decompose | â‰¤8 hours |

### Planning Authority

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHO DECIDES WHAT                                                    â”‚
â”‚                                                                      â”‚
â”‚  Human  â”€â”€â–º WHETHER to plan (yes/no)                                 â”‚
â”‚  DREAM  â”€â”€â–º HOW to plan (folder vs file, which docs)                â”‚
â”‚                                                                      â”‚
â”‚  Human override suppresses auto-format-detection.                    â”‚
â”‚  Agents do NOT decide whether planning happens.                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Folder Structure â€” The Main Event

> **Bridge:** Every DREAM artifact is either a **Plan** (directory with `_overview.md`) or a **Task** (single `.md` file). The folder tree below shows how these two primitives compose into real projects.

### Folder Naming Convention â€” Plan Type Prefixes

Plan directories use a **mandatory type prefix** that encodes plan type and creation order:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PREFIX FORMAT:  {TYPE}{NN}_{plan_name}/                         â”‚
â”‚                                                                   â”‚
â”‚  TYPE:  SP = System Plan    PP = Procedure Plan                  â”‚
â”‚  NN:    Two-digit creation order (01, 02, 03...)                 â”‚
â”‚                                                                   â”‚
â”‚  RULES:                                                           â”‚
â”‚  â€¢ Numbers are IMMUTABLE â€” never reassigned after creation       â”‚
â”‚  â€¢ Gaps are allowed (SP01, SP03 â€” SP02 was cut or is procedure)  â”‚
â”‚  â€¢ Numbers reflect creation order across ALL plan types          â”‚
â”‚  â€¢ Visible when folders are collapsed in file explorer           â”‚
â”‚  â€¢ Applies to both active plans AND archived plans in _completed â”‚
â”‚                                                                   â”‚
â”‚  EXAMPLES:                                                        â”‚
â”‚    SP01_core_shop/        â† 1st plan created, System type        â”‚
â”‚    PP02_checkout_redesign/ â† 2nd plan created, Procedure type    â”‚
â”‚    SP03_marketplace/      â† 3rd plan created, System type        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Full Blueprint â€” System Plan

A System Plan describes **what to build** â€” architecture, modules, features, and phased implementation. Architecture stabilizes early while the summary evolves, so they are separate files.

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md                         â† Root navigator + Current Sprint + Module Index + State Deltas (capped at 20)
â”œâ”€â”€ _tree.md                             â† On-demand generated folder tree (dream tree) â€” NEVER hand-maintained
â”œâ”€â”€ _state_deltas_archive.md             â† Overflow State Deltas (auto-generated by dream_mcp, never hand-maintained)
â”‚
â”œâ”€â”€ SP01_{plan_name}/                    â† ğŸ”„ [WIP] System Plan â€” named plan directory
â”‚   â”œâ”€â”€ _overview.md                     â† REQUIRED â€” plan navigator (frontmatter: name, magnitude, status, origin, timestamps, depends_on, blocks, knowledge_gaps, priority)
â”‚   â”œâ”€â”€ 01_executive_summary.md          â† Vision, goals, non-goals, prior art
â”‚   â”œâ”€â”€ 02_architecture.md               â† System diagrams, components (stabilizes early)
â”‚   â”œâ”€â”€ 0N_{feature_name}.md             â† Feature specs (one per feature)
â”‚   â”œâ”€â”€ 80_implementation.md             â† Phased roadmap with verification
â”‚   â”œâ”€â”€ 81_module_structure.md           â† Reusable vs project-specific modules
â”‚   â”œâ”€â”€ 82_cli_commands.md               â† CLI interface (if applicable)
â”‚   â”œâ”€â”€ 99_references.md                 â† External links
â”‚   â”‚
â”‚   â”œâ”€â”€ p00_{phase}/                     â† Phase directory (sequential)
â”‚   â”‚   â”œâ”€â”€ _overview.md                 â† REQUIRED
â”‚   â”‚   â”œâ”€â”€ 01_{task}.md                 â† Numbered task files
â”‚   â”‚   â””â”€â”€ 02_{task}.md
â”‚   â”œâ”€â”€ p01_{phase}/
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â””â”€â”€ 01_{task}.md
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                         â† Module specs (if needed)
â”‚   â”‚   â””â”€â”€ {module_name}.md             â† Contains last_updated + modified_by_plans + knowledge_gaps frontmatter
â”‚   â”‚
â”‚   â””â”€â”€ assets/                          â† Supporting artifacts
â”‚       â””â”€â”€ {id}_{desc}.asset.md
â”‚
â”œâ”€â”€ _completed/                          â† Archive of âœ… DONE and ğŸš« CUT plans (moved here on closure)
â”‚   â”œâ”€â”€ 2025-Q1/                         â† Quarterly sub-grouping (v4.04)
â”‚   â”‚   â””â”€â”€ SP01_{plan_name}/            â† Retains prefix â€” never renamed
â”‚   â”œâ”€â”€ 2025-Q3/
â”‚   â”‚   â””â”€â”€ PP02_{plan_name}/
â”‚   â””â”€â”€ 2026-Q1/
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ exploration/                         â† Research/exploration docs (decisions recorded here)
â”‚   â””â”€â”€ _archive/
â””â”€â”€ _templates/                          â† Plan templates (read-only, underscore = infrastructure)
```

### Full Blueprint â€” Procedure Plan

A Procedure Plan describes **how to do something** â€” a workflow, migration, or operational process. Summary and architecture co-evolve and are lightweight, so they merge into a single file.

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md                         â† Root navigator + Current Sprint + Module Index + State Deltas (capped at 20)
â”œâ”€â”€ _tree.md                             â† On-demand generated folder tree (dream tree)
â”œâ”€â”€ _state_deltas_archive.md             â† Overflow State Deltas (auto-generated, never hand-maintained)
â”‚
â”œâ”€â”€ PP03_{plan_name}/                    â† ğŸ”„ [WIP] Procedure Plan â€” named plan directory
â”‚   â”œâ”€â”€ _overview.md                     â† REQUIRED â€” plan navigator (frontmatter: name, magnitude, status, origin, timestamps, depends_on, blocks, knowledge_gaps, priority)
â”‚   â”œâ”€â”€ 01_summary.md                    â† Merged: vision + architecture (co-evolve)
â”‚   â”œâ”€â”€ 0N_{step_name}.md               â† Step/stage specs
â”‚   â”œâ”€â”€ 80_implementation.md             â† Phased roadmap with verification
â”‚   â”œâ”€â”€ 99_references.md                 â† External links
â”‚   â”‚
â”‚   â”œâ”€â”€ p00_{phase}/                     â† Phase directory (sequential)
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â””â”€â”€ 01_{task}.md
â”‚   â”‚
â”‚   â””â”€â”€ assets/                          â† Supporting artifacts (if needed)
â”‚       â””â”€â”€ {id}_{desc}.asset.md
â”‚
â”œâ”€â”€ _completed/                          â† Archive of âœ… DONE and ğŸš« CUT plans
â”‚   â”œâ”€â”€ 2025-Q1/
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ exploration/
â”‚   â””â”€â”€ _archive/
â””â”€â”€ _templates/
```

**What Procedure Plans OMIT (files don't exist on disk):**

| File | Why Omitted |
|------|-------------|
| `02_architecture.md` | Merged into `01_summary.md` |
| `81_module_structure.md` | Procedures rarely define new modules |
| `82_cli_commands.md` | Procedures rarely define new CLI commands |
| `modules/` directory | No module specs needed |

### Simple Tier (Either Type)

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md                         â† Root navigator
â”œâ”€â”€ {project}_vision.md                  â† Single file, â‰¤200 lines
â””â”€â”€ _templates/
```

### Root-Level Infrastructure Files

| File | Purpose | Who Maintains |
|------|---------|---------------|
| `_overview.md` | Root navigator: Current Sprint, plan table, Module Index, State Deltas (capped at 20) | Root MANAGER / `dream_mcp` only |
| `_tree.md` | Complete folder tree with inline status annotations | `dream tree` (on-demand generated). **NEVER** hand-maintained |
| `_state_deltas_archive.md` | Overflow State Delta entries (>20) | `dream_mcp` (auto-generated). **NEVER** hand-maintained |
| `_completed/` | Archive directory for âœ… DONE and ğŸš« CUT plans, organized by `YYYY-QN/` | `dream archive` or authors move plans here on closure |
| `_templates/` | Template scaffolds (read-only, never edit templates directly) | HyperDream (template ownership) |
| `exploration/` | Research docs, meeting notes, decision records | Authors |

> **v4.04** â€” `_tree.md` is now strictly on-demand generated. The header reads `<!-- GENERATED â€” run 'dream tree' to refresh -->`. No agent or human should hand-edit this file. `_state_deltas_archive.md` is new â€” it stores overflow State Delta entries beyond the 20-entry cap in root `_overview.md`.

### `_tree.md` Specification

> **v4.04** â€” `_tree.md` is now an **on-demand generated artifact** produced by `dream tree`. It is never statically maintained. The header explicitly marks it as generated.

The `_tree.md` file is a **generated folder tree** that provides a complete, annotated view of the day-dream directory.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _tree.md RULES (v4.04)                                           â”‚
â”‚                                                                    â”‚
â”‚  Header:   <!-- GENERATED â€” run 'dream tree' to refresh -->      â”‚
â”‚  Content:  Entire folder tree with inline annotations              â”‚
â”‚  Author:   dream_mcp (generated via `dream tree`)                 â”‚
â”‚  Edit:     NEVER hand-maintained â€” always regenerated              â”‚
â”‚  Refresh:  On-demand via `dream tree` command                      â”‚
â”‚  Staleness: File may be stale between generations â€” this is OK    â”‚
â”‚  Until P0: dream_mcp walking skeleton ships _tree.md generation   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Example `_tree.md` content:**

```markdown
<!-- GENERATED â€” run 'dream tree' to refresh -->
# Day Dream â€” Folder Tree
_Generated: 2026-02-12T14:30:00_

.agent_plan/day_dream/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ _tree.md
â”œâ”€â”€ _state_deltas_archive.md
â”œâ”€â”€ SP01_core_shop/                      â† âœ… [DONE] System Plan
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_executive_summary.md
â”‚   â”œâ”€â”€ 02_architecture.md
â”‚   â”œâ”€â”€ 03_product_catalog.md
â”‚   â””â”€â”€ 80_implementation.md
â”œâ”€â”€ PP02_checkout_redesign/              â† âœ… [DONE] Procedure Plan
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_summary.md
â”‚   â””â”€â”€ 80_implementation.md
â”œâ”€â”€ SP03_marketplace/                    â† ğŸ”„ [WIP] System Plan â€” depends_on: SP01
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_executive_summary.md
â”‚   â””â”€â”€ p00_walking_skeleton/            â† ğŸ”„ [WIP]
â”‚       â”œâ”€â”€ _overview.md
â”‚       â””â”€â”€ 01_vendor_api.md
â”œâ”€â”€ _completed/
â”‚   â”œâ”€â”€ 2025-Q3/
â”‚   â”‚   â”œâ”€â”€ SP01_core_shop/
â”‚   â”‚   â””â”€â”€ PP02_checkout_redesign/
â”‚   â””â”€â”€ 2026-Q1/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ exploration/
â”‚   â””â”€â”€ _archive/
â””â”€â”€ _templates/
```

---

## How Variables Shape the Structure

Three variables modify what appears on disk: **Magnitude**, **Tier**, and **Plan Type**. Each adds or removes files/directories from the full blueprint shown above.

### Variable 1: Magnitude â†’ Controls Decomposition Depth

Magnitude determines HOW DEEP the plan tree goes. Higher magnitude = more structure.

#### Trivial (â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡ max 1 slot)

No planning artifacts. Execute immediately.

```
(no files created â€” work happens inline)
```

#### Light (â– â– â–¡â–¡â–¡â–¡â–¡â–¡ max 2 slots)

Optional single file. No directory structure.

```
.agent_plan/day_dream/
â””â”€â”€ {task}_vision.md          â† Optional, only if documentation value exists
```

#### Standard (â– â– â– â–¡â–¡â–¡â–¡â–¡ max 3 slots)

Plan directory appears if â‰¥3 subtasks or cross-module. Tasks live directly in plan directory (no phases).

```
SP04_{plan_name}/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ 01_executive_summary.md   â† System Plan
â”‚   (or 01_summary.md)        â† Procedure Plan
â”œâ”€â”€ 80_implementation.md
â”œâ”€â”€ 01_{task}.md
â”œâ”€â”€ 02_{task}.md
â””â”€â”€ 03_{task}.md
```

#### Heavy (â– â– â– â– â– â–¡â–¡â–¡ max 5 slots)

Full blueprint with phase directories. Should decompose.

```
SP05_{plan_name}/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ 01_executive_summary.md
â”œâ”€â”€ 02_architecture.md         â† System Plan only
â”œâ”€â”€ 03_{feature}.md
â”œâ”€â”€ 80_implementation.md
â”œâ”€â”€ 81_module_structure.md     â† System Plan only
â”œâ”€â”€ p00_{phase}/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_{task}.md
â”‚   â””â”€â”€ 02_{task}.md
â”œâ”€â”€ p01_{phase}/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â””â”€â”€ 01_{task}.md
â””â”€â”€ assets/
```

#### Epic (â– â– â– â– â– â– â– â–  max 8 slots â€” MUST decompose)

Full blueprint with nested plan directories inside phases. Mandatory decomposition with parallel agents.

```
SP06_{plan_name}/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ 01_executive_summary.md
â”œâ”€â”€ 02_architecture.md         â† System Plan only
â”œâ”€â”€ 03_{feature_a}.md
â”œâ”€â”€ 04_{feature_b}.md
â”œâ”€â”€ 80_implementation.md
â”œâ”€â”€ 81_module_structure.md     â† System Plan only
â”œâ”€â”€ 82_cli_commands.md         â† If CLI exists
â”œâ”€â”€ 99_references.md
â”œâ”€â”€ p00_{phase}/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ {sub_plan}/            â† Nested plan (parallel-safe)
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â”œâ”€â”€ 01_{task}.md
â”‚   â”‚   â””â”€â”€ 02_{task}.md
â”‚   â””â”€â”€ 01_{task}.md
â”œâ”€â”€ p01_{phase}/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â””â”€â”€ ...
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ {module_a}.md
â”‚   â””â”€â”€ {module_b}.md
â””â”€â”€ assets/
    â””â”€â”€ {id}_{desc}.asset.md
```

### Variable 2: Tier â†’ Controls Documentation Depth

Tier determines WHAT KIND of documentation is created.

| Tier | Trigger | Structure |
|------|---------|-----------|
| **Simple** | â‰¤2 features, single module, no external APIs | Single `.md` file |
| **Blueprint** | â‰¥3 features OR â‰¥2 cross-module deps OR external APIs | Plan directory with structured docs |

```
Simple:
  â””â”€â”€ {name}_vision.md               â† Everything in one file

Blueprint:
  â””â”€â”€ SP01_{name}/                    â† Directory with structured files
      â”œâ”€â”€ _overview.md
      â”œâ”€â”€ 01_executive_summary.md     â† (or 01_summary.md for Procedure)
      â”œâ”€â”€ ...
      â””â”€â”€ 80_implementation.md
```

**Human requests planning â†’ DREAM selects tier based on scope.** Human override can force Simple or Blueprint.

### Variable 3: Plan Type â†’ Controls Which Files Exist

One folder structure, two template profiles. The primitives are identical â€” only which files appear on disk differs.

| File | System Plan | Procedure Plan | Why |
|------|:-----------:|:--------------:|-----|
| `_overview.md` | âœ… | âœ… | Always required |
| `01_executive_summary.md` | âœ… | â€” | Replaced by `01_summary.md` |
| `01_summary.md` | â€” | âœ… | Merged exec summary + architecture |
| `02_architecture.md` | âœ… | â€” | Merged into `01_summary.md` |
| `0N_{feature}.md` | âœ… | âœ… | Feature/step specs |
| `80_implementation.md` | âœ… | âœ… | Always needed |
| `81_module_structure.md` | âœ… | â€” | Procedures rarely define modules |
| `82_cli_commands.md` | Optional | â€” | Only if CLI exists |
| `99_references.md` | Optional | Optional | External links |
| `modules/` | Optional | â€” | Module specs |
| `assets/` | Optional | Optional | Supporting artifacts |
| `pNN_{phase}/` | As needed | As needed | Phase directories |

### Combo Examples

Here are concrete examples showing how the three variables combine:

#### Example A: Simple + Light + System

*"Add retry logic to the HTTP client"*

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md
â””â”€â”€ http_retry_vision.md       â† Single file (or no file at all)
```

#### Example B: Blueprint + Standard + System

*"Add OAuth2 support with 3 providers"*

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ _tree.md
â”œâ”€â”€ SP04_oauth2/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_executive_summary.md
â”‚   â”œâ”€â”€ 02_architecture.md
â”‚   â”œâ”€â”€ 03_google_provider.md
â”‚   â”œâ”€â”€ 04_github_provider.md
â”‚   â”œâ”€â”€ 05_custom_provider.md
â”‚   â””â”€â”€ 80_implementation.md
â””â”€â”€ _templates/
```

#### Example C: Blueprint + Heavy + Procedure

*"Migrate all modules from pip to uv"*

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ _tree.md
â”œâ”€â”€ PP05_uv_migration/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_summary.md              â† Merged (procedure = co-evolving summary + arch)
â”‚   â”œâ”€â”€ 03_foundation_modules.md
â”‚   â”œâ”€â”€ 04_runtime_modules.md
â”‚   â”œâ”€â”€ 05_dev_modules.md
â”‚   â”œâ”€â”€ 80_implementation.md
â”‚   â”œâ”€â”€ p00_prerequisites/
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â”œâ”€â”€ 01_install_uv.md
â”‚   â”‚   â””â”€â”€ 02_audit_deps.md
â”‚   â”œâ”€â”€ p01_foundation/
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â”œâ”€â”€ 01_config_manager.md
â”‚   â”‚   â””â”€â”€ 02_logger_util.md
â”‚   â””â”€â”€ p02_runtime/
â”‚       â”œâ”€â”€ _overview.md
â”‚       â””â”€â”€ 01_remaining_modules.md
â”œâ”€â”€ _completed/
â”‚   â””â”€â”€ 2025-Q3/
â””â”€â”€ _templates/
```

#### Example D: Blueprint + Epic + System

*"Build a plugin system with marketplace and sandboxing"*

```
.agent_plan/day_dream/
â”œâ”€â”€ _overview.md
â”œâ”€â”€ _tree.md
â”œâ”€â”€ SP06_plugin_system/
â”‚   â”œâ”€â”€ _overview.md
â”‚   â”œâ”€â”€ 01_executive_summary.md
â”‚   â”œâ”€â”€ 02_architecture.md
â”‚   â”œâ”€â”€ 03_plugin_loader.md
â”‚   â”œâ”€â”€ 04_sandbox_runtime.md
â”‚   â”œâ”€â”€ 05_marketplace_api.md
â”‚   â”œâ”€â”€ 80_implementation.md
â”‚   â”œâ”€â”€ 81_module_structure.md
â”‚   â”œâ”€â”€ 82_cli_commands.md
â”‚   â”œâ”€â”€ 99_references.md
â”‚   â”œâ”€â”€ p00_walking_skeleton/
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â”œâ”€â”€ 01_plugin_interface.md
â”‚   â”‚   â””â”€â”€ 02_loader_stub.md
â”‚   â”œâ”€â”€ p01_core_features/
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â”œâ”€â”€ sandbox/
â”‚   â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â”‚   â”œâ”€â”€ 01_process_isolation.md
â”‚   â”‚   â”‚   â””â”€â”€ 02_resource_limits.md
â”‚   â”‚   â””â”€â”€ 01_dependency_resolver.md
â”‚   â”œâ”€â”€ p02_marketplace/
â”‚   â”‚   â”œâ”€â”€ _overview.md
â”‚   â”‚   â””â”€â”€ 01_api_endpoints.md
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ plugin_loader.md
â”‚   â”‚   â””â”€â”€ sandbox_runtime.md
â”‚   â””â”€â”€ assets/
â”‚       â”œâ”€â”€ 03_plugin_lifecycle_diagram.asset.md
â”‚       â””â”€â”€ 04_sandbox_architecture.asset.md
â”œâ”€â”€ _completed/
â”‚   â””â”€â”€ 2025-Q1/
â”œâ”€â”€ exploration/
â”‚   â””â”€â”€ _archive/
â””â”€â”€ _templates/
```

---

## Chapter 1 â€” Author

This chapter answers: *"How do I write plan documents?"*

### 1.1 Magnitude Assessment

Assess magnitude **first**. This is agent judgment, not a rigid checklist.

| Signal | Points Toward |
|--------|--------------|
| Single file change | Trivial/Light |
| Multiple files, one module | Light/Standard |
| Cross-module changes | Standard/Heavy |
| New module or external API | Heavy/Epic |
| Ambiguity in requirements | Standard+ (needs decomposition) |

### 1.2 Routing Decision

```
Is magnitude Epic?            â”€â”€YESâ”€â”€â–º MUST decompose (MANAGER role)
                                â”‚
Is magnitude Heavy?            â”€â”€YESâ”€â”€â–º SHOULD decompose (MANAGER role)
                                â”‚
Is magnitude Standard          â”€â”€YESâ”€â”€â–º Decompose if â‰¥3 subtasks
  AND â‰¥3 subtasks?                      or cross-module. Otherwise execute.
                                â”‚
Trivial or Light?              â”€â”€YESâ”€â”€â–º Execute directly (WORKER role)
```

Epic at task level â†’ **REFUSE and escalate**. Epic work cannot be a leaf task.

### 1.3 Tier Selection

DREAM selects tier **after human initiates planning**:

| Tier | Use When | Template |
|------|----------|----------|
| **Simple** | â‰¤2 features, single module, no external APIs | `simple.template.md` |
| **Blueprint** | â‰¥3 features OR â‰¥2 cross-module deps OR external APIs | `blueprint/` folder |

Format detection signals (used by DREAM to pick tier):

| Condition | Threshold | Tier |
|-----------|-----------|------|
| Feature count | â‰¥3 | Blueprint |
| Cross-module imports | â‰¥2 | Blueprint |
| External API | Any | Blueprint |

Human override can force tier in either direction.

### 1.4 Plan Type Selection

| Plan Type | Use When | Prefix | Key Difference |
|-----------|----------|--------|----------------|
| **System Plan** | Building/extending software architecture | `SP` | Separate `01_executive_summary.md` + `02_architecture.md` |
| **Procedure Plan** | Workflow, migration, operational process | `PP` | Merged `01_summary.md` (exec + arch co-evolve) |

Both types share the same primitives: `_overview.md`, status markers, magnitude, sibling firewall, phase directories, task files.

**Tiebreaker rule:** If a plan is triggered by an existing plan AND its primary deliverable modifies existing code (rather than creating new modules), it is a **Procedure Plan**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TIEBREAKER EXAMPLES                                               â”‚
â”‚                                                                    â”‚
â”‚  checkout_redesign                                                 â”‚
â”‚    Triggered by: core_shop (existing plan)                        â”‚
â”‚    Primary deliverable: modifies existing checkout code            â”‚
â”‚    Result: PP (Procedure Plan) âœ…                                  â”‚
â”‚                                                                    â”‚
â”‚  marketplace                                                       â”‚
â”‚    Triggered by: NOT an existing plan (new initiative)             â”‚
â”‚    Primary deliverable: creates new vendor_portal module           â”‚
â”‚    Result: SP (System Plan) âœ…                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.5 Tier Ã— Magnitude Matrix

| Combo | Route |
|-------|-------|
| Simple + Trivial/Light | Execute directly â€” no planning doc |
| Simple + Standard | Single plan file, execute in-session |
| Blueprint + Light/Standard | Blueprint docs, execute sequentially |
| Blueprint + Heavy | Blueprint docs, decompose into plan/task tree |
| Blueprint + Epic | Blueprint docs, mandatory decomposition, parallel agents |

### 1.6 Human vs AI Routing

| Route to **Human** | Route to **AI** |
|--------------------|-----------------|
| Goal alignment ("is this right?") | Goal execution ("build this") |
| Acceptance testing with real users | Unit/integration tests |
| Novel domain knowledge not in codebase | Standard patterns |
| Subjective quality (UX, aesthetics) | Objective quality (lint, compile) |

Mark human-routed tasks with `human_only: true` in frontmatter. These use human time estimates.

### 1.7 Walking Skeleton Policy

Walking skeleton is **opt-in** â€” not every project needs one.

| **When REQUIRED** (opt-in triggers) | **When NOT needed** (skip) |
|--------------------------------------|----------------------------|
| Cross-boundary integration risk | Single-module changes |
| External API dependency | Skill/template/doc edits |
| Multi-module data flow (3+ modules) | Self-contained features |
| | Magnitude â‰¤ Light |

### 1.8 The Story â†’ Spec Pattern

Every blueprint document **MUST** follow this two-part structure:

```markdown
## ğŸ“– The Story
{Visual, scannable narrative â€” NOT a text wall}

---

## ğŸ”§ The Spec
{Technical specification}
```

### 1.9 Story Section Structure (Visual-First)

| Subsection | Purpose | Format |
|------------|---------|--------|
| ğŸ˜¤ **The Pain** | What's broken, who hurts | ASCII box + pain table |
| âœ¨ **The Vision** | What success looks like | ASCII box showing flow |
| ğŸ¯ **One-Liner** | Elevator pitch | Single blockquote |
| ğŸ“Š **Impact** | Before/After metrics | Comparison table |

**Principle:** If you can't draw the pain and vision, you don't understand the feature.

### 1.10 Status Syntax

| Marker | Meaning |
|--------|---------|
| â³ `[TODO]` | Not started |
| ğŸ”„ `[WIP]` | In progress |
| âœ… `[DONE]` | Complete |
| âœ… `[DONE:invalidated-by:XXnn]` | Complete but assumptions retroactively compromised by plan `XXnn` |
| ğŸš§ `[BLOCKED:reason]` | Stuck (use kebab-case, e.g., `[BLOCKED:waiting-on-api]`) |
| ğŸš« `[CUT]` | Removed from scope |

> **v4.04** â€” The `âœ… [DONE:invalidated-by:XXnn]` variant is new. It enables tree-level scanning of retroactive invalidations. The `XXnn` suffix uses the standard plan prefix (e.g., `PP08`, `SP15`). See [Â§1.11 Plan Invalidation Protocol](#111-plan-invalidation-protocol) for full details.

### 1.11 Plan Invalidation Protocol

> **v4.04** â€” New section. Addresses Finding #3 from the v4.03 stress test: completed work whose assumptions are retroactively compromised has no structured detection mechanism.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLAN INVALIDATION â€” WHO / WHERE / WHEN / HOW                               â”‚
â”‚                                                                              â”‚
â”‚  WHERE:  `invalidated_by:` field lives in the VICTIM plan's frontmatter     â”‚
â”‚  WHO:    Causing plan REPORTS invalidations at its closure gate              â”‚
â”‚  HOW:    Parent/orchestrator writes to victim plan (sibling firewall safe)  â”‚
â”‚  SAFETY: `dream validate` detects unwritten invalidations from DAG          â”‚
â”‚                                                                              â”‚
â”‚  STATUS VARIANT:                                                             â”‚
â”‚    âœ… [DONE:invalidated-by:PP08]   â† in plan/phase status field            â”‚
â”‚                                                                              â”‚
â”‚  FRONTMATTER:                                                                â”‚
â”‚    invalidated_by: PP08_polyglot_persistence                                â”‚
â”‚    invalidation_scope: storage_implementation                                â”‚
â”‚    invalidation_date: 2025-09-15                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Frontmatter example (victim plan/phase `_overview.md`):**

```yaml
---
name: audit_schema_setup
status: DONE:invalidated-by:PP08
invalidated_by: PP08_polyglot_persistence
invalidation_scope: storage_implementation    # what parts are compromised
invalidation_date: 2025-09-15                 # when invalidation was recorded
---
```

**Invalidation flow:**

```
PP08 reaches âœ… DONE
  â”‚
  â”œâ”€â–º PP08's author identifies: "PP06/p00 assumed PostgreSQL, we changed to DynamoDB"
  â”‚
  â”œâ”€â–º PP08's closure gate: REPORT invalidations list
  â”‚     â””â”€â–º "PP06/p00_audit_schema â†’ storage_implementation invalidated"
  â”‚
  â”œâ”€â–º Parent/orchestrator writes `invalidated_by:` to PP06/p00/_overview.md
  â”‚     (sibling firewall: PP08 agent does NOT write to PP06 â€” parent does)
  â”‚
  â””â”€â–º `dream validate` independently checks:
        â€¢ Does PP08's dependency DAG include PP06?
        â€¢ Are there unwritten invalidations?
        â€¢ Surfaces as warning if parent forgot to write
```

**Rules:**

| Rule | Detail |
|------|--------|
| Only `âœ… [DONE]` plans/phases can be invalidated | You can't invalidate something that hasn't been built yet |
| `invalidation_scope` is required | Must say WHAT is compromised, not just "partially invalidated" |
| Causing plan must report | Listed in the causing plan's closure gate |
| Parent writes to victim | Sibling firewall compliance â€” agents never write to sibling plans |
| `dream validate` is safety net | Independently detects unwritten invalidations from dependency DAG |

### 1.12 Difficulty Labels

| Label | Meaning | P0 Allowed? |
|-------|---------|-------------|
| `[KNOWN]` | Standard patterns, proven libraries | âœ… Yes |
| `[EXPERIMENTAL]` | Needs validation in our context | âš ï¸ Conditional |
| `[RESEARCH]` | Active problem, no proven solution | âŒ **NEVER** in P0 |

### 1.13 Acceptance Criteria

Task files **MUST** include `## Acceptance Criteria` with checkbox lists:

```markdown
## Acceptance Criteria

- [ ] Login endpoint returns JWT on valid credentials
- [ ] Invalid credentials return 401 with error message
- [ ] Token expires after configured TTL
```

### 1.14 `_overview.md` Convention

Every plan directory **MUST** contain `_overview.md`. This is the agent's entry point.

#### Plan-Level `_overview.md`

**Required frontmatter:**

```yaml
---
name: {plan_name}
type: system | procedure
magnitude: Trivial | Light | Standard | Heavy | Epic
status: TODO | WIP | DONE | DONE:invalidated-by:XXnn | BLOCKED:reason | CUT
origin: exploration/{doc_name}.md    # What triggered this plan
start_at: 2026-02-10                 # Optional â€” when work began (YYYY-MM-DD for human, ISO 8601 for dream_mcp)
last_updated: 2026-02-12             # MANDATORY â€” last modification date (YYYY-MM-DD for human, ISO 8601 for dream_mcp)
---
```

> **v4.04** â€” Additional optional frontmatter fields below. All follow omit-when-default.

**Optional frontmatter (v4.04):**

```yaml
---
# Cross-plan dependency graph (P1) â€” plan-level ONLY, not task/phase level
depends_on:                          # Plans this plan requires to complete first
  - SP05_billing_engine
blocks:                              # Plans that cannot proceed until this plan completes
  - PP19_perf_optimization

# Knowledge gaps (P1) â€” source of truth for aggregation
knowledge_gaps:                      # What expertise or information is missing
  - "X12 EDI format expertise"
  - "Session handoff protocol for telemedicine"

# Priority (P2) â€” binary only, omit for normal
priority: emergency                  # normal (default, omit) | emergency

# Invalidation (P0) â€” only in victim plans, written by parent/orchestrator
invalidated_by: PP08_polyglot_persistence
invalidation_scope: storage_implementation
invalidation_date: 2025-09-15
---
```

> **v4.04** â€” `depends_on:` and `blocks:` are **plan-level only** â€” never on individual tasks or phases. They form a lightweight DAG that `dream impact {plan_id}` traverses. `ğŸš§ [BLOCKED:reason]` remains orthogonal â€” it's a temporal status, while `depends_on:` is structural.

**Dependency graph vs blocked status:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STRUCTURAL vs TEMPORAL                                                  â”‚
â”‚                                                                          â”‚
â”‚  depends_on: SP05_billing_engine                                        â”‚
â”‚    â† "This plan's design ASSUMES SP05 is complete"                      â”‚
â”‚    â† Structural relationship. Permanent. Part of the causal model.      â”‚
â”‚    â† Used by `dream impact` for DAG traversal.                          â”‚
â”‚                                                                          â”‚
â”‚  ğŸš§ [BLOCKED:waiting-on-api]                                            â”‚
â”‚    â† "Work is paused RIGHT NOW because of a temporary obstacle"         â”‚
â”‚    â† Temporal status. Transient. Clears when obstacle resolves.         â”‚
â”‚    â† Used by `dream status` for current sprint visibility.              â”‚
â”‚                                                                          â”‚
â”‚  A plan can have depends_on: AND not be BLOCKED                         â”‚
â”‚  (dependency is met). Or BLOCKED without depends_on: (external delay).  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Timestamp precision rules:**

| Author | `start_at` | `last_updated` | Format |
|--------|-----------|----------------|--------|
| Human | Optional | **MANDATORY** | `YYYY-MM-DD` |
| `dream_mcp` | Optional | **MANDATORY** | `YYYY-MM-DDTHH:MM:SS` (ISO 8601) |

`start_at` is optional because some plans are exploratory â€” they exist before active work begins.

**Required content:**

```markdown
---
name: {plan_name}
type: system
magnitude: Heavy
status: WIP
origin: exploration/meeting_2026_02_01_auth.md
start_at: 2026-02-03
last_updated: 2026-02-12
depends_on:
  - SP01_core_shop
knowledge_gaps:
  - "OAuth token refresh edge cases under load"
---

# {Plan Name}

## Purpose
Why this plan exists and what it delivers.

## Children

| Name | Type | Status | Description |
|------|------|--------|-------------|
| 01_login_flow.md | Task | â³ [TODO] | Login endpoint |
| auth_tokens/ | Plan | ğŸ”„ [WIP] | Token lifecycle |

## Integration Map
How children's outputs combine into the plan's deliverable.

## Reading Order
1. 01_login_flow.md (independent)
2. auth_tokens/ (depends on login)
```

#### Root `_overview.md` â€” Extended Sections

> **v4.04** â€” Root `_overview.md` write access is restricted: only the root MANAGER or `dream_mcp` writes to this file. Individual agents update their own plan's `status:` frontmatter only. The root Plans table is rebuilt at integration time or via `dream_mcp`.

The root `_overview.md` (at `.agent_plan/day_dream/_overview.md`) has additional **required sections** beyond the standard plan convention:

```markdown
# Day Dream â€” Root Overview

## Current Sprint

- ğŸ”„ SP03_marketplace/p01 â€” order splitting logic (Agent-B)
- â³ SP03_marketplace/p02 â€” payout system, commission engine
- ğŸ”„ SP03_marketplace/05_order_routing.md â€” multi-vendor cart

## Plans

| Name | Type | Status | Priority | Depends On | Description |
|------|------|--------|----------|------------|-------------|
| SP01_core_shop | System | âœ… [DONE] | â€” | â€” | Initial storefront |
| PP02_checkout_redesign | Procedure | âœ… [DONE] | â€” | SP01 | State machine migration |
| SP03_marketplace | System | ğŸ”„ [WIP] | â€” | SP01 | Multi-vendor platform |
| PP13_compliance_fix | Procedure | ğŸ”„ [WIP] | emergency | â€” | HIPAA audit response |

## Module Index

| Module | Origin Plan | Modified By | Knowledge Gaps |
|--------|------------|-------------|----------------|
| product_catalog | SP01_core_shop | PP04_multitenancy_migration | â€” |
| cart | SP01_core_shop | PP05_payment_migration | â€” |
| checkout | SP01_core_shop | PP02, PP04, PP05 | â€” |
| vendor_portal | SP03_marketplace | â€” | "Multi-currency settlement" |

## State Deltas

> **v4.04** â€” Capped at 20 most recent entries. Older entries archived to `_state_deltas_archive.md`.

### âœ… PP02_checkout_redesign â€” Sep 2025
- checkout: linear flow â†’ reservation-based state machine
- inventory_sync: new module, pessimistic locking + TTL

### âœ… PP05_payment_migration â€” Nov 2025
- checkout: direct Stripe calls â†’ PaymentProvider abstraction
- payment: new module with Stripe/PayPal/Mollie adapters
```

> **v4.04** â€” The Plans table now includes `Priority` and `Depends On` columns. The Module Index now includes a `Knowledge Gaps` column. These columns surface cross-plan relationships and missing expertise at the root level.

**Root `_overview.md` required sections:**

| Section | Position | Purpose |
|---------|----------|---------|
| `## Current Sprint` | **FIRST** content section | 3â€“5 bullets of actively worked items |
| `## Plans` | After Current Sprint | All plans (active + completed) with type, status, priority, dependencies |
| `## Module Index` | After Plans | Maps each module to origin plan + modifier plans + knowledge gaps |
| `## State Deltas` | **LAST** section | Append-only changelog â€” capped at 20 entries, overflow â†’ `_state_deltas_archive.md` |

#### State Delta Cap & Archive

> **v4.04** â€” New. Addresses Finding #7 (root `_overview.md` becomes monolithic) by capping State Deltas.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STATE DELTA CAP RULES                                                   â”‚
â”‚                                                                          â”‚
â”‚  â€¢ Root _overview.md holds the 20 MOST RECENT State Delta entries       â”‚
â”‚  â€¢ When a 21st entry is added, the oldest is moved to                   â”‚
â”‚    _state_deltas_archive.md                                              â”‚
â”‚  â€¢ _state_deltas_archive.md is auto-generated by dream_mcp             â”‚
â”‚  â€¢ _state_deltas_archive.md is NEVER hand-maintained                    â”‚
â”‚  â€¢ Until dream_mcp exists: human moves oldest entry manually when       â”‚
â”‚    adding new ones (best effort)                                         â”‚
â”‚  â€¢ Archive file header: <!-- GENERATED â€” managed by dream_mcp -->       â”‚
â”‚                                                                          â”‚
â”‚  WHY 20?                                                                 â”‚
â”‚  â€¢ 20 entries â‰ˆ ~60â€“100 lines (manageable in a single file)              â”‚
â”‚  â€¢ At 1 entry/week cadence: covers ~5 months of recent history          â”‚
â”‚  â€¢ Older entries lose immediate relevance â€” archive is searchable       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Module History (Auto-Generated)

> **v4.04** â€” New. Addresses Finding #5 (State Delta scanning is O(n) per module).

Module History is a **module-indexed view** alongside the chronological State Deltas. It is **never hand-maintained** â€” it is auto-generated by `dream history {module}` from State Delta entries.

```markdown
## Module History (auto-generated by `dream history audit_trail`)

### audit_trail
| Date | Plan | Change |
|------|------|--------|
| Feb 2025 | SP02 | Created â€” auth event logging to PostgreSQL |
| Sep 2025 | PP08 | PostgreSQL JSONB â†’ DynamoDB event store |
| Nov 2025 | PP13 | DynamoDB encryption enabled (critical gap) |
| Feb 2026 | PP06 | Scope expanded: auth-only â†’ platform-wide PHI |
```

**Rules:**

| Rule | Detail |
|------|--------|
| Source of truth | State Deltas (chronological) remain the source |
| Module History | Derived view, auto-generated, never hand-maintained |
| Command | `dream history {module}` extracts from State Delta entries |
| Output | Printed to stdout or written to plan-local file (not root) |
| Until `dream_mcp` | Module History does not exist â€” use grep on State Deltas |

### 1.15 Module Spec Frontmatter

Module spec files (in `modules/` directories within plans) track staleness and provenance:

```yaml
---
module: checkout
last_updated: 2025-09-15        # MANDATORY â€” updated when any plan modifies this module
modified_by_plans:               # Audit trail
  - PP02_checkout_redesign
  - PP05_payment_migration
knowledge_gaps:                  # v4.04 â€” expertise/info gaps for this module
  - "Payment retry logic under partial failure"
---
```

> **v4.04** â€” Module specs now support `knowledge_gaps:` frontmatter. This is the same format as plan-level `knowledge_gaps:` and feeds into `dream status --gaps` aggregation.

Any plan that modifies a module's behavior **MUST** update `last_updated` in the owning plan's module spec.

### 1.16 Knowledge-Gap Annotation

> **v4.04** â€” New section. Addresses Finding #6 (no formalized knowledge-gap annotation). Formalizes the ad-hoc `âš ï¸ KNOWLEDGE GAP` pattern observed in the MedFlow stress test.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KNOWLEDGE GAPS â€” FRONTMATTER vs PROSE                                   â”‚
â”‚                                                                          â”‚
â”‚  SOURCE OF TRUTH:  `knowledge_gaps:` frontmatter field (string array)   â”‚
â”‚  AGGREGATION:      `dream status --gaps` scans all plans + modules      â”‚
â”‚  INLINE PROSE:     `âš ï¸ [KNOWLEDGE GAP]` remains valid annotation        â”‚
â”‚                    for readability, but is NOT the source of truth       â”‚
â”‚                                                                          â”‚
â”‚  LIVES IN:                                                               â”‚
â”‚    â€¢ Plan _overview.md frontmatter (plan-level gaps)                    â”‚
â”‚    â€¢ Module spec frontmatter (module-level gaps)                        â”‚
â”‚    â€¢ Root Module Index table (Knowledge Gaps column, for visibility)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Frontmatter format:**

```yaml
---
knowledge_gaps:
  - "X12 EDI format expertise departed with Carlos"
  - "Session handoff protocol â€” Raj was sole expert"
  - "DynamoDB partition key strategy for high-cardinality audit events"
---
```

**When to add a knowledge gap:**

| Trigger | Example |
|---------|---------|
| Key person departs | Raj leaves â†’ telemedicine video expertise gone |
| Domain expertise missing | No one on team understands X12 EDI |
| Unvalidated assumption | "We assume DynamoDB can handle 10K writes/sec" |
| External dependency unknown | Third-party API rate limits undocumented |

**Resolving knowledge gaps:** Remove from `knowledge_gaps:` array when expertise is acquired, validated, or documented. Add a State Delta entry noting the resolution.

### 1.17 Level Annotation (Optional)

Levels are **L0â€“LN** â€” optional communication aids with no formal machinery. Use them when referring to plans in discussion. Do **not** encode them in filenames or metadata.

```
SP06_plugin_system/        â† L0 (root plan)
â”œâ”€â”€ feature_auth/          â† L1 (sub-plan)
â”‚   â”œâ”€â”€ oauth/             â† L2
â”‚   â”‚   â””â”€â”€ task.md        â† L2 (task)
â”‚   â””â”€â”€ task.md            â† L1 (task)
â””â”€â”€ task.md                â† L0 (task)
```

L0=plan, L1=sub-plan covers 95% of real use cases. Label when useful, ignore when not.

### 1.18 Executive Summary Requirements

| Rule | Detail |
|------|--------|
| **TL;DR** | Maximum 3 sentences |
| **Prior Art** | **MUST** include `## ğŸ” Prior Art & Existing Solutions` with BUY/BUILD/WRAP decisions |
| **Non-Goals** | Minimum 3 items |
| **Features** | Maximum 5 P0 features |
| **Freeze** | Mark ğŸ”’ FROZEN after approval â€” do not edit |

### 1.19 Estimation Defaults

All durations use **AI-agent time** unless marked `human_only: true`.

| Magnitude | Max Slots | AI-Agent Time | Human Time (ref) |
|-----------|-----------|---------------|-------------------|
| Trivial | 1 | â‰¤1 hour | 1â€“2 hours |
| Light | 2 | â‰¤2 hours | 2â€“8 hours |
| Standard | 3 | â‰¤3 hours | 1â€“3 days |
| Heavy | 5 | â‰¤5 hours | 3â€“7 days |
| Epic | 8 | â‰¤8 hours (must decompose) | Must decompose |

### 1.20 P0 Hard Limits

| Constraint | Limit |
|------------|-------|
| Max tasks | 5 |
| Max slots | 5 |
| Difficulty allowed | `[KNOWN]` only |
| `[RESEARCH]` in P0 | âŒ **NEVER** |

**Anti-Premature-Optimization:** If you cannot describe each P0 component in one sentence without the word "and," it's too complex. Split or defer.

### 1.21 Natural Verification

Every implementation phase **MUST** have a `### How to Verify (Manual)` section:

- Max 3 human-executable steps
- Expected outcome for each step
- Steps **MUST** complete in <30 seconds

```markdown
### How to Verify (Manual)

1. Run `adhd list modules` â†’ expect auth_manager in output
2. Run `adhd test auth` â†’ expect all tests pass
3. Check `modules/runtime/auth_manager/__init__.py` exists â†’ expect file present
```

### 1.22 Phasing Rules

| Phase | Constraint |
|-------|-----------|
| **P0 (Walking Skeleton / Foundation)** | Max 5 tasks, max 5 slots, `[KNOWN]` only. Working passthrough/stub. NO complex logic |
| **P1 (First Enhancement)** | Add ONE simple heuristic or feature. Validate before adding more |
| **P2+** | Gradually layer complexity. Each phase independently deployable |

### 1.23 Mandatory Skeleton Pattern (Documents)

Distinct from walking skeleton (code). This governs document sections:

| Old Pattern | New Pattern |
|-------------|-------------|
| `<!-- Optional: ... -->` | Section present; write "N/A â€” [reason]" if not applicable |

### 1.24 Custom Sections (FREE ZONE)

- **Prefix:** `## [Custom] ğŸ¨ Title`
- **Maximum:** 5 per document
- **Prohibited content:** P0 tasks, blocking dependencies, architecture changes

### 1.25 Deep Dive Section

Add `## ğŸ”¬ Deep Dive` only when algorithms, API contracts, or error handling need explicit design. Delete for straightforward features.

### 1.26 Asset Authoring

**Naming:** `{feature_id}_{description}.asset.md`  
**Types:** `mockup` Â· `diagram` Â· `storyboard` Â· `infrastructure` Â· `design` Â· `data-model` Â· `other`

| Section | Limit |
|---------|-------|
| Context | ~20 lines |
| The Artifact | Mermaid diagram, ASCII mockup, etc. |
| Constraints | ~10 lines |
| Related Features | Links to dependent features |

| **Total** (excl. diagrams) | **â‰¤100 lines** |

**Diagram rules:** Mermaid for all supported chart types. ASCII art only when Mermaid does not support the format. Prefer SVG over PNG/JPG.

### 1.27 Exploration Docs & Decision Recording

- Maximum **3 active explorations** at any time
- Each expires after **14 days**
- Archived to `exploration/_archive/` when synthesized or expired

**Decision recording rule:** Decisions that create, modify, or cut plans **MUST** be recorded in the exploration/meeting doc with explicit links to affected plans. This is documentation-time, not optional.

```markdown
# meeting_2026_02_10_marketplace.md

## Decisions
- âœ… CREATE: SP03_marketplace/ (System Plan, Epic)
- ğŸš« CUT: SP01_core_shop/05_recommendation_engine.md
- ğŸš« CUT: mobile_optimization_vision.md
```

Failure to record decisions creates context loss. If a meeting doc gets archived without capturing plan-affecting decisions, provenance is broken.

### 1.28 Clean-Code-First Directive

Plans **MUST** specify clean, correct code over minimizing edited lines:

1. **Delete wrong code** â€” do not wrap in fallbacks
2. **Refactor fully** â€” no half-migrated paths
3. **One correct path** â€” not `try (new) catch (old)`
4. **Measure success by correctness** â€” not lines changed

When backward compatibility IS genuinely needed, use folder separation (`v1/`, `v2/`), never try/catch fallbacks.

### 1.29 Blueprint Document Rules

| Document | Required When | Line Limit |
|----------|---------------|------------|
| `_overview.md` | Every plan directory | â‰¤100 lines |
| `01_executive_summary.md` | Blueprint, System Plan | â‰¤150 lines |
| `01_summary.md` | Blueprint, Procedure Plan | â‰¤200 lines |
| `02_architecture.md` | System Plan with â‰¥3 modules/cross-module/ext API | â‰¤200 lines |
| `80_implementation.md` | Blueprint tier | â‰¤200 lines per phase |
| `81_module_structure.md` | System Plan, ADHD projects | â‰¤150 lines |
| `82_cli_commands.md` | Plan has CLI commands | â‰¤150 lines |
| Feature (full) | â‰¥3 modules, external APIs, P0 | â‰¤300 lines |
| Feature (simple) | â‰¤2 modules, no external APIs | â‰¤100 lines |
| Task file | Any leaf task | â‰¤100 lines |
| Asset file | Supporting artifact | â‰¤100 lines (excl. diagrams) |

---

## Chapter 2 â€” Execute & Verify

This chapter answers: *"How do agents process plans and tasks?"*

### 2.1 Core Primitives

| Primitive | Representation | Has Children? | Required File |
|-----------|---------------|---------------|---------------|
| **Plan** | Directory | Yes | `_overview.md` |
| **Task** | Single `.md` file | No | â€” |

### 2.2 Bootstrap Sequence

When an agent enters a plan directory:

```
1. Enter directory
2. Read _overview.md              â† frontmatter (metadata) + children + reading order
3. Check parent's _overview.md    â† boundary check: what is my scope?
4. Decide: MANAGER or WORKER
5. Execute appropriate lifecycle
```

### 2.3 MANAGER Lifecycle (Processes a Plan)

```
DECOMPOSE  â”€â”€â–º Verify/create children with _overview.md
               Break ambiguity into concrete children
                              â”‚
                              â–¼
DELEGATE   â”€â”€â–º Assign each child to a subagent
               Max 5 parallel subagents
               Apply sibling firewall to each branch
                              â”‚
                              â–¼
INTEGRATE  â”€â”€â–º Collect results, merge outputs
               Resolve conflicts between siblings
               No child output is final until parent accepts
                              â”‚
                              â–¼
REPORT     â”€â”€â–º Mark plan status = âœ… [DONE]
               Notify parent
               Complete plan closure gates (see Â§2.11)
               Report invalidations caused by this plan
```

**MANAGER rules:**

- **MUST** create `_overview.md` if it does not exist
- **MUST NOT** fulfill children's tasks directly â€” always delegate
- **MUST** integrate: no child output is final until parent accepts
- **MUST** cap at 5 parallel subagents
- **MUST** report invalidations at closure gate (v4.04)

### 2.4 WORKER Lifecycle (Fulfills a Task)

```
VALIDATE   â”€â”€â–º Check magnitude â‰  Epic (refuse + escalate if Epic)
               Check dependencies are resolved
                              â”‚
                              â–¼
IMPLEMENT  â”€â”€â–º Read task spec, create/modify artifacts
               DO NOT modify sibling tasks or parent plan
                              â”‚
                              â–¼
VERIFY     â”€â”€â–º Check acceptance criteria
               Run verification steps
                              â”‚
                              â–¼
REPORT     â”€â”€â–º Mark task status = âœ… [DONE]
               Notify parent
```

**WORKER rules:**

- **MUST** refuse Epic-magnitude tasks â€” escalate to parent
- **MUST NOT** modify sibling tasks or parent plan content
- **MUST** report completion to parent (status marker update)

### 2.5 Sibling Firewall

The most critical rule in DREAM. Prevents parallel agents from corrupting each other's context.

| Scope | What Agent Can See |
|-------|-------------------|
| **Read** | Own task/plan + all ancestors up to root + skill files |
| **Write** | Own task/plan **ONLY** |
| **Sibling status** | Yes â€” via parent's `_overview.md` |
| **Sibling content** | **NO â€” NEVER** |

### 2.6 Parallel Execution Safety

| Scenario | Parallel Safe? | Reason |
|----------|---------------|--------|
| Siblings with no shared writes | âœ… Yes | No race conditions |
| Siblings needing parent state | âŒ No | Sequential â€” parent integrates |
| Workers on independent branches | âœ… Yes | No shared ancestors modified |

### 2.7 How Siblings Coordinate

Siblings do **NOT** coordinate directly. The parent MANAGER:

1. Delegates tasks to children
2. Waits for children to report completion
3. Integrates results in its own INTEGRATE phase
4. Resolves any conflicts between sibling outputs

### 2.8 Updating Shared Files

For any request to update a file owned by a higher layer, the agent **MUST** report this to the parent. The parent decides how to proceed.

### 2.9 Subagent Dispatch

Dispatch is **informal** via orchestrator and skills. The MANAGER describes the task, points to the target directory/file, and states context boundaries. No formal YAML dispatch schema.

### 2.10 Flatten Rule

A plan with only 1 child is suspicious â€” probably a task disguised as a plan. **SHOULD** flatten single-child plans.

**Exception:** Phases (`pNN_name/`) are always directories. This overrides the flatten rule because sequential ordering **MUST** be preserved in file explorers.

### 2.11 Plan Closure â€” Gates & Procedures

When marking a plan âœ… DONE or ğŸš« CUT, the following gates **MUST** be satisfied:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLAN CLOSURE GATES (v4.04)                                          â”‚
â”‚                                                                      â”‚
â”‚  ALL PLANS:                                                          â”‚
â”‚  â˜ All children marked âœ… DONE or ğŸš« CUT                            â”‚
â”‚  â˜ State Delta appended to root _overview.md (GATE CONDITION)       â”‚
â”‚  â˜ Module Index updated â€” new modules REGISTERED (GATE CONDITION)   â”‚
â”‚  â˜ Plan directory moved to _completed/YYYY-QN/                     â”‚
â”‚  â˜ last_updated frontmatter updated in plan's _overview.md          â”‚
â”‚  â˜ Invalidations reported â€” list plans/phases this work compromises â”‚
â”‚                                                                      â”‚
â”‚  PROCEDURE PLANS (additional):                                       â”‚
â”‚  â˜ Reconciliation checklist completed in plan's _overview.md        â”‚
â”‚                                                                      â”‚
â”‚  ENFORCEMENT:                                                        â”‚
â”‚  dream_mcp validates these gates. Until then,                       â”‚
â”‚  agents self-enforce and human reviews on closure.                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **v4.04** â€” Two new gate conditions: **Module Index registration** (Finding #4) and **Invalidation reporting** (Finding #3). A phase that introduces a new module CANNOT be marked âœ… DONE until the module appears in the root Module Index. Invalidations caused by this plan MUST be listed at closure.

#### Module Index Enforcement Gate

> **v4.04** â€” New. Addresses Finding #4 (Module Index drifts without enforcement).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MODULE INDEX GATE CONDITION                                         â”‚
â”‚                                                                      â”‚
â”‚  A phase that introduces a new module CANNOT mark âœ… DONE until     â”‚
â”‚  the module appears in the root _overview.md Module Index.          â”‚
â”‚                                                                      â”‚
â”‚  WHO REGISTERS:                                                      â”‚
â”‚  â€¢ The plan's MANAGER requests registration via parent              â”‚
â”‚  â€¢ Root MANAGER / dream_mcp performs the actual write               â”‚
â”‚                                                                      â”‚
â”‚  ENFORCEMENT:                                                        â”‚
â”‚  â€¢ `dream validate` checks registration completeness               â”‚
â”‚  â€¢ Flags: "SP18 created reporting_engine but Module Index has       â”‚
â”‚    no entry for it"                                                  â”‚
â”‚                                                                      â”‚
â”‚  UNTIL dream_mcp:                                                    â”‚
â”‚  â€¢ Agents self-enforce â€” add module to root Module Index            â”‚
â”‚    before marking phase DONE                                         â”‚
â”‚  â€¢ Human reviews on closure                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### State Delta (GATE CONDITION)

A plan **CANNOT** be marked âœ… DONE without appending a State Delta entry to the root `_overview.md`. State Deltas are **append-only** entries logging what changed in the codebase.

```markdown
## State Deltas

### âœ… PP02_checkout_redesign â€” Sep 2025
- checkout: linear flow â†’ reservation-based state machine
- inventory_sync: new module, pessimistic locking + TTL

### âœ… PP05_payment_migration â€” Nov 2025
- checkout: direct Stripe calls â†’ PaymentProvider abstraction
- payment: new module with Stripe/PayPal/Mollie adapters
```

**Reading State Deltas tells you any module's full history in 30 seconds** â€” scan top-to-bottom for that module's name.

> **v4.04** â€” State Deltas in root `_overview.md` are capped at 20 entries. See [State Delta Cap & Archive](#state-delta-cap--archive) for overflow rules.

#### Reconciliation Checklist (Procedure Plans Only)

When a Procedure Plan is marked âœ… DONE, the author **MUST** complete a reconciliation checklist in the plan's `_overview.md`. This verifies that all touched module specs are updated.

```markdown
## Reconciliation
- [x] checkout.md (SP01_core_shop/modules/) â€” last_updated: 2025-09-15
- [x] inventory_sync.md (SP01_core_shop/modules/) â€” last_updated: 2025-09-15
- [x] cart.md (SP01_core_shop/modules/) â€” reviewed, no changes needed
```

#### Archival to `_completed/`

> **v4.04** â€” Archival now uses quarterly sub-grouping: `_completed/YYYY-QN/`. `dream archive {plan_id}` automates the move (P1).

When a plan reaches âœ… DONE or ğŸš« CUT:

1. Move the plan directory to `.agent_plan/day_dream/_completed/YYYY-QN/` (quarter of closure)
2. The plan retains its original prefix (e.g., `SP01_core_shop/` stays `SP01_core_shop/`)
3. The root `_overview.md` retains a summary row with status and completion date
4. Active plans remain in the day-dream root

```
BEFORE closure:                         AFTER closure:
.agent_plan/day_dream/                  .agent_plan/day_dream/
â”œâ”€â”€ SP01_core_shop/    â† âœ… DONE       â”œâ”€â”€ SP03_marketplace/  â† ğŸ”„ WIP (active)
â”œâ”€â”€ SP03_marketplace/  â† ğŸ”„ WIP       â”œâ”€â”€ _completed/
â””â”€â”€ ...                                â”‚   â””â”€â”€ 2025-Q3/
                                       â”‚       â””â”€â”€ SP01_core_shop/ â† archived
                                       â””â”€â”€ ...
```

**Quarterly grouping convention:**

```
_completed/
â”œâ”€â”€ 2025-Q1/
â”‚   â””â”€â”€ SP02_auth_hipaa/
â”œâ”€â”€ 2025-Q3/
â”‚   â”œâ”€â”€ SP03_scheduling/
â”‚   â”œâ”€â”€ PP07_nosql_migration/          â† CUT
â”‚   â””â”€â”€ PP08_polyglot_persistence/
â”œâ”€â”€ 2025-Q4/
â”‚   â”œâ”€â”€ SP04_telemedicine/
â”‚   â””â”€â”€ PP13_compliance_emergency/
â””â”€â”€ 2026-Q1/
    â””â”€â”€ PP16_api_gateway/
```

> **v4.04** â€” Quarter-based grouping (`YYYY-QN/`) chosen over domain-based because it's unambiguous â€” every plan has exactly one closure date. `dream archive PP13` creates the quarter directory if needed and moves the plan.

### 2.12 Phase Directories

| Rule | Detail |
|------|--------|
| Naming | `pNN_name/` â€” zero-padded two digits, underscore separator |
| Examples | `p00_prerequisites/`, `p01_core_commands/`, `p02_polish/` |
| Always directories | Even single-task phases. Never flatten phases |
| Task numbering | `NN_task_name.md` starting at `01_` (`00_` is implicitly `_overview.md`) |
| Capacity | Up to `p99_` â€” more than sufficient for any plan |

### 2.13 When to Stop Decomposing

A unit is a **task** (leaf) when:
- A single agent can fulfill it in a single session
- There is no ambiguity about what to produce
- Its magnitude is Standard or below

A unit is a **plan** (container) when:
- It contains ambiguity requiring further breakdown
- It has â‰¥2 children that can be worked independently
- Its magnitude is Heavy or Epic

### 2.14 `dream_mcp` â€” Enforcement Module

> **v4.04** â€” Promoted from P1 to P0 walking skeleton. The v4.03 stress test proved `dream_mcp` is load-bearing infrastructure, not a convenience tool. Two days of manual audit (MedFlow Stage 7) validated that staleness detection, tree generation, and module validation are essential services.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dream_mcp â€” FULL SCOPE (Heavy magnitude, Blueprint tier, phased delivery)  â”‚
â”‚                                                                              â”‚
â”‚  P0 WALKING SKELETON (3 commands)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  dream status   â€” Current sprint, active plans, blocked plans, emergency    â”‚
â”‚  dream tree     â€” Regenerate _tree.md on demand                             â”‚
â”‚  dream stale    â€” Flag module specs where last_updated > N weeks            â”‚
â”‚                                                                              â”‚
â”‚  P1 EXPANSION (4 commands)                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  dream validate â€” Check gate conditions, Module Index completeness,         â”‚
â”‚                   detect unwritten invalidations from dependency DAG         â”‚
â”‚  dream impact   â€” DAG walk: "if I change X, what plans are affected?"       â”‚
â”‚                   Traverses depends_on:/blocks: frontmatter                  â”‚
â”‚  dream history  â€” Module-indexed view from State Delta entries              â”‚
â”‚                   Auto-generated, never hand-maintained                      â”‚
â”‚  dream archive  â€” Move completed plan to _completed/YYYY-QN/               â”‚
â”‚                   Creates quarter directory if needed                        â”‚
â”‚                                                                              â”‚
â”‚  PROPERTIES (all phases):                                                    â”‚
â”‚  â€¢ Read-only â€” validates but NEVER mutates plan files                       â”‚
â”‚    (exception: dream archive moves directories)                              â”‚
â”‚  â€¢ Reports â€” surfaces staleness, gate violations, status                    â”‚
â”‚  â€¢ Deterministic â€” same input always produces same output                   â”‚
â”‚                                                                              â”‚
â”‚  ENABLES (cumulative):                                                       â”‚
â”‚  P0:                                                                         â”‚
â”‚    â€¢ Staleness detection (last_updated age)                                  â”‚
â”‚    â€¢ _tree.md generation with inline annotations                             â”‚
â”‚    â€¢ Plan status table (active/blocked/emergency)                            â”‚
â”‚                                                                              â”‚
â”‚  P0 + P1:                                                                    â”‚
â”‚    â€¢ Gate condition enforcement (State Delta + Module Index checks)          â”‚
â”‚    â€¢ Module Index registration validation                                    â”‚
â”‚    â€¢ Invalidation detection from dependency DAG                              â”‚
â”‚    â€¢ Cross-plan impact analysis (DAG traversal)                              â”‚
â”‚    â€¢ Module History generation from State Deltas                             â”‚
â”‚    â€¢ Quarterly archival automation                                            â”‚
â”‚    â€¢ Knowledge-gap aggregation (--gaps flag)                                 â”‚
â”‚    â€¢ Timestamp precision (machine-authored ISO 8601)                         â”‚
â”‚    â€¢ Plan prefix validation (SP/PP + creation order)                         â”‚
â”‚                                                                              â”‚
â”‚  UNTIL P0 SHIPS:                                                             â”‚
â”‚    Agents self-enforce all conventions.                                      â”‚
â”‚    Manual _tree.md generation is NOT acceptable â€” defer until P0.           â”‚
â”‚    Human reviews plan closures for gate compliance.                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### `dream_mcp` Command Reference

| Command | Phase | Input | Output | Mutates? |
|---------|-------|-------|--------|----------|
| `dream status` | P0 | Reads all `_overview.md` frontmatter | Plan status table sorted by priority | No |
| `dream status --gaps` | P1 | Reads `knowledge_gaps:` from all plans + modules | Aggregated gap list | No |
| `dream tree` | P0 | Scans `.agent_plan/day_dream/` directory tree | Writes `_tree.md` with status annotations | Yes (writes `_tree.md`) |
| `dream stale` | P0 | Reads `last_updated` from module specs | List of modules older than N weeks | No |
| `dream validate` | P1 | Reads all plans, Module Index, dependency DAG | Gate violations, unregistered modules, unwritten invalidations | No |
| `dream impact {plan_id}` | P1 | Reads `depends_on:`/`blocks:` frontmatter | DAG walk showing affected plans | No |
| `dream history {module}` | P1 | Reads State Delta entries | Module-indexed change history | No |
| `dream archive {plan_id}` | P1 | Reads plan status, determines quarter | Moves plan to `_completed/YYYY-QN/` | Yes (moves directory) |

#### `dream status` Output Example

```
$ dream status

â”Œâ”€ DREAM Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  ğŸš¨ EMERGENCY                                                    â”‚
â”‚  PP13_compliance_fix        ğŸ”„ [WIP]   p01 in progress          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“‹ ACTIVE                                                       â”‚
â”‚  SP03_marketplace           ğŸ”„ [WIP]   p01 â€” order splitting    â”‚
â”‚  SP09_analytics             â³ [TODO]  depends_on: SP05         â”‚
â”‚                                                                  â”‚
â”‚  ğŸš§ BLOCKED                                                      â”‚
â”‚  PP06_audit_expansion       ğŸš§ [BLOCKED:pp08-storage-change]    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š Knowledge Gaps: 3 (use --gaps for details)                   â”‚
â”‚  âš ï¸  Stale modules: 2 (use `dream stale` for details)           â”‚
â”‚  âŒ Gate violations: 1 (use `dream validate` for details)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### `dream impact` Output Example

```
$ dream impact SP05_billing_engine

â”Œâ”€ Impact Analysis: SP05_billing_engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  DIRECT DEPENDENTS (blocks:)                                     â”‚
â”‚  â””â”€â”€ PP19_perf_optimization    â³ [TODO]  depends_on: SP05      â”‚
â”‚                                                                  â”‚
â”‚  TRANSITIVE DEPENDENTS                                           â”‚
â”‚  â””â”€â”€ SP09_analytics            â³ [TODO]  depends_on: PP19      â”‚
â”‚                                                                  â”‚
â”‚  MODULES AFFECTED                                                â”‚
â”‚  â””â”€â”€ billing_engine            Origin: SP05                      â”‚
â”‚      â””â”€â”€ Modified by: PP19 (planned)                             â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸  Changing SP05 may invalidate: PP19, SP09                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.15 Validation Checklists

**Feature checklist:**

- [ ] Story section clearly states user problem and value
- [ ] Intent is unambiguous to a non-technical reader
- [ ] Scope is explicitly bounded
- [ ] Integration Points table has all connections
- [ ] Edge Cases cover failure scenarios
- [ ] Acceptance Criteria are testable

**Module checklist:**

- [ ] Implements Features section links to â‰¥1 feature OR marked as utility
- [ ] All linked features have backlinks to this module spec
- [ ] Responsibilities clearly state DO and DON'T
- [ ] Public API section defines interface contract
- [ ] `last_updated` frontmatter is current
- [ ] `modified_by_plans` lists all plans that touched this module
- [ ] `knowledge_gaps` frontmatter is current (empty array if none)

**Plan closure checklist:**

- [ ] All children marked âœ… DONE or ğŸš« CUT
- [ ] State Delta appended to root `_overview.md`
- [ ] Module Index updated â€” new modules registered
- [ ] `last_updated` frontmatter updated
- [ ] Plan moved to `_completed/YYYY-QN/`
- [ ] Invalidations reported (list compromised plans/phases)
- [ ] (Procedure Plans) Reconciliation checklist completed

---

## Templates Reference

All templates at: `.agent_plan/day_dream/_templates/`

> **Note:** Templates directory was renamed from `templates/` to `_templates/` in v4.03. The underscore prefix follows the infrastructure convention established by `_overview.md` and `_completed/`.

### Simple Tier

| Template | Purpose | Line Limit |
|----------|---------|------------|
| `simple.template.md` | Single-file vision + quick start | â‰¤200 lines |

### Blueprint Tier

| Template | Purpose | Line Limit |
|----------|---------|------------|
| `blueprint/overview.template.md` | `_overview.md` scaffold â€” plan navigator (includes `origin:`, timestamps, `depends_on:`, `blocks:`, `knowledge_gaps:`, `priority:`) | â‰¤100 lines |
| `blueprint/task.template.md` | Leaf task scaffold â€” atomic work unit | â‰¤100 lines |
| `blueprint/00_index.template.md` | Navigation hub with flowchart | â‰¤150 lines |
| `blueprint/01_executive_summary.template.md` | Vision, goals, non-goals, prior art (System Plan) | â‰¤150 lines |
| `blueprint/01_summary.template.md` | Merged summary + architecture (Procedure Plan) | â‰¤200 lines |
| `blueprint/02_architecture.template.md` | System diagrams, logical components (System Plan only) | â‰¤200 lines |
| `blueprint/NN_feature.template.md` | Full feature spec (â‰¥3 modules or ext API) | â‰¤150 lines |
| `blueprint/NN_feature_simple.template.md` | Lightweight feature (80% of cases) | â‰¤100 lines |
| `blueprint/80_implementation.template.md` | Phased roadmap with verification (8-slot scale) | â‰¤200 lines/phase |
| `blueprint/81_module_structure.template.md` | Reusable vs project-specific modules (System Plan only) | â‰¤150 lines |
| `blueprint/82_cli_commands.template.md` | CLI interface and command reference | â‰¤150 lines |
| `blueprint/99_references.template.md` | External links | No limit |
| `blueprint/exploration.template.md` | Research/exploration doc | â€” |
| `blueprint/modules/module_spec.template.md` | Detailed module implementation spec (includes `last_updated`, `knowledge_gaps` frontmatter) | â‰¤200 lines |

### Assets

| Template | Purpose | Line Limit |
|----------|---------|------------|
| `assets/asset.template.md` | Non-code artifacts (mockups, diagrams) | â‰¤100 lines (excl. diagrams) |

### Template Selection Flowchart

```
What are you creating?
  â”‚
  â”œâ”€â”€ Quick vision, â‰¤2 features? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º simple.template.md
  â”‚
  â”œâ”€â”€ Plan directory navigator? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º blueprint/overview.template.md
  â”‚
  â”œâ”€â”€ Leaf task? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º blueprint/task.template.md
  â”‚
  â”œâ”€â”€ Feature spec?
  â”‚   â”œâ”€â”€ â‰¤2 modules, no ext API? â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º NN_feature_simple.template.md
  â”‚   â””â”€â”€ â‰¥3 modules or ext API? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º NN_feature.template.md
  â”‚
  â”œâ”€â”€ System Plan blueprint?
  â”‚   â”œâ”€â”€ Executive summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 01_executive_summary.template.md
  â”‚   â””â”€â”€ Architecture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 02_architecture.template.md
  â”‚
  â”œâ”€â”€ Procedure Plan blueprint?
  â”‚   â””â”€â”€ Summary (merged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 01_summary.template.md
  â”‚
  â”œâ”€â”€ Implementation roadmap? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 80_implementation.template.md
  â”‚
  â””â”€â”€ Supporting artifact? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º assets/asset.template.md
```

### Slot Notation for Implementation Plans

Duration fields in `80_implementation.md` use the 8-slot visual scale:

```
â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡  Trivial  (max 1 slot)
â– â– â–¡â–¡â–¡â–¡â–¡â–¡  Light    (max 2 slots)
â– â– â– â–¡â–¡â–¡â–¡â–¡  Standard (max 3 slots)
â– â– â– â– â– â–¡â–¡â–¡  Heavy    (max 5 slots)
â– â– â– â– â– â– â– â–   Epic     (max 8 slots â€” must decompose)
```

### Examples

Located at `_templates/examples/`:

| Example | Demonstrates |
|---------|-------------|
| `blueprint_example/` | Complete blueprint folder structure |
| `simple_example.md` | Completed simple-tier document |
| `deep_dive_*.example.md` | Algorithm proof, API contract, architecture, state machine |
| `free_zone_*.example.md` | Assumption graveyard, metaphor map, philosophical tensions |

---

## Anti-Patterns

### Planning & Authority

| Don't | Do Instead |
|-------|------------|
| Agent decides whether to plan | Human initiates planning; DREAM decides format |
| Force planning on Trivial/Light work | Execute directly â€” no planning doc |
| Skip magnitude assessment | Always assess magnitude first |
| Create a plan without `origin:` | Always trace provenance to exploration/meeting doc |

### Decomposition

| Don't | Do Instead |
|-------|------------|
| Siblings communicating directly | Route through parent's INTEGRATE phase |
| Epic-magnitude leaf task | Decompose into plan with children |
| Plan with only 1 child (non-phase) | Flatten â€” it is probably a task |
| MANAGER fulfilling tasks directly | Delegate to WORKER subagents |
| Agent reading sibling content | Read sibling STATUS only (via parent) |
| Deep nesting (>3 levels) | Flatten or re-scope |

### Naming & Structure

| Don't | Do Instead |
|-------|------------|
| Plan folder without type prefix | Use `SP01_` or `PP01_` â€” always |
| Reassign plan numbers after creation | Numbers are IMMUTABLE â€” gaps are fine |
| Hand-edit `_tree.md` | Let `dream tree` regenerate it |
| Keep completed plans in root | Move to `_completed/YYYY-QN/` on plan closure |
| Flat `_completed/` at scale | Use quarterly sub-grouping `YYYY-QN/` |
| Hand-maintain `_state_deltas_archive.md` | Let `dream_mcp` manage overflow |
| Hand-maintain Module History | Use `dream history {module}` to generate |

### Authoring

| Don't | Do Instead |
|-------|------------|
| `[RESEARCH]` in P0 | Defer to P1+ or resolve in exploration |
| Exceed line limits | Split into separate files |
| Edit frozen (ğŸ”’) documents | Create new version or update implementation |
| >3 active explorations | Synthesize or abandon oldest |
| Skip verification sections | Always include manual verification |
| Simple tier for complex projects | Upgrade to Blueprint when threshold met |
| Embed code in assets | Assets are for visuals/planning only |
| Orphan assets | Always link to parent feature |
| Human-time estimates for AI tasks | Default to AI-agent time scale |
| Force walking skeleton on all projects | Check opt-in triggers first |
| Text-wall Story sections | ASCII boxes, tables, emoji anchors |
| Fill omitted files with "N/A" | Omit the file from disk entirely |
| Skip `last_updated` on module specs | Always include and maintain it |
| Close plan without State Delta | State Delta is a GATE CONDITION â€” mandatory |
| Close plan without Module Index check | Module registration is a GATE CONDITION â€” mandatory |
| Close Procedure Plan without reconciliation | Complete the reconciliation checklist |
| Make plan decisions without recording them | Record all create/modify/cut decisions in exploration docs |
| Skip invalidation reporting at closure | List all plans/phases this work compromises |
| Use `knowledge_gaps:` only in prose | Frontmatter is source of truth; prose is supplementary |
| Write `depends_on:` at task/phase level | Plan-level only â€” never on individual tasks or phases |
| Mark `priority: normal` explicitly | Omit-when-default â€” `normal` is the default |
| Agent writes to root `_overview.md` directly | Only root MANAGER / `dream_mcp` writes to root |

### Code Quality

| Don't | Do Instead |
|-------|------------|
| Wrap old code in try/catch fallbacks | Delete old code or separate into v1/v2 folders |
| Minimize lines changed over correctness | Prioritize clean, correct code |
| Leave half-migrated paths | Refactor fully â€” one correct path |

---

## Deprecated (v4.03 â†’ v4.04)

| Change | Was (v4.03) | Now (v4.04) |
|--------|-------------|-------------|
| `dream_mcp` priority | P1 convenience tool | **P0** load-bearing infrastructure (walking skeleton: 3 commands) |
| `_tree.md` maintenance | Manual OK until `dream_mcp` exists | **NEVER** hand-maintained â€” on-demand via `dream tree` only |
| `_completed/` structure | Flat archive directory | Quarterly sub-grouping `_completed/YYYY-QN/` |
| Plan invalidation | Prose annotation in `_overview.md` | Structured `invalidated_by:` frontmatter + `âœ… [DONE:invalidated-by:XXnn]` status variant |
| Module Index enforcement | Manual convention, no gate | **GATE CONDITION** â€” new modules MUST be registered before phase marks DONE |
| Knowledge gaps | Ad-hoc `âš ï¸ KNOWLEDGE GAP` prose | `knowledge_gaps:` frontmatter array (source of truth). Prose remains valid for readability |
| State Deltas size | Unbounded in root `_overview.md` | Capped at 20 entries. Overflow â†’ `_state_deltas_archive.md` |
| Module History | Not available | Auto-generated by `dream history {module}` (P1). Never hand-maintained |
| Root `_overview.md` write access | Any author could modify | Only root MANAGER / `dream_mcp`. Agents update own plan's frontmatter only |
| Plans table columns | Name, Type, Status, Description | Added `Priority` and `Depends On` columns |
| Module Index columns | Module, Origin Plan, Modified By | Added `Knowledge Gaps` column |
| Priority | Not tracked | `priority: emergency | normal` (binary, omit-when-default) |
| Cross-plan dependencies | Implicit in prose | `depends_on:` / `blocks:` frontmatter (optional, plan-level only) |
| Plan closure gates | State Delta + archival + reconciliation | Added Module Index registration + invalidation reporting |
| Plan frontmatter | name, type, magnitude, status, origin, timestamps | Added `depends_on`, `blocks`, `knowledge_gaps`, `priority`, `invalidated_by`, `invalidation_scope`, `invalidation_date` |

### Earlier Deprecations (v4.02 â†’ v4.03)

| Change | Was (v4.02) | Now (v4.03) |
|--------|-------------|-------------|
| Plan folder naming | `{plan_name}/` (bare names) | `{TYPE}{NN}_{plan_name}/` â€” mandatory `SP01_`/`PP01_` prefix |
| Templates directory | `templates/` | `_templates/` â€” underscore prefix = infrastructure convention |
| Plan `_overview.md` frontmatter | `name`, `magnitude`, `status` only | Added `type`, `origin`, `start_at`, `last_updated` |
| Root `_overview.md` | Plan list only | Added `## Current Sprint` (first), `## Module Index`, `## State Deltas` (last) |
| Plan closure | Mark status âœ… DONE | Gate conditions: State Delta + archival to `_completed/` + (Procedure) reconciliation checklist |
| Module specs | No staleness tracking | `last_updated` + `modified_by_plans` frontmatter mandatory |
| Completed plans | Stay in root forever | Move to `_completed/` on closure |
| Folder tree visibility | Read individual `_overview.md` files | `_tree.md` auto-generated by `dream_mcp` (read-only) |
| Plan type selection | No tiebreaker for edge cases | Tiebreaker: existing plan trigger + modifies existing code â†’ Procedure |
| Decision recording | Implicit/optional | Mandatory: create/modify/cut decisions recorded in exploration docs |
| Timestamps | Not specified | Precision rules: human = `YYYY-MM-DD`, machine = ISO 8601 |

### Earlier Deprecations (v3 â†’ v4.02)

| Removed | Was | Why Deprecated |
|---------|-----|----------------|
| `node.yaml` | Per-node routing metadata (~15 lines) | Replaced by `_overview.md` frontmatter |
| `contract.yaml` | Per-node execution spec (~40 lines) | Acceptance criteria inline in task files |
| `plan.yaml` | Separate 3-line metadata file | Moved into `_overview.md` frontmatter |
| `.spec.md` files | L4 implementation detail | Tasks include `## Acceptance Criteria` directly |
| `state/` directory | Machine-managed JSON (execution, history) | Status lives in document markers |
| `phases/*.yaml` | Aggregated phase files at project root | Phases are `pNN_name/` directories inline |
| `DREAM_AGENT_CARD.md` | Protocol rules file read first by agents | Protocol lives in skills loaded at activation |
| Complexity Classes Aâ€“D | Human review gates (Surfaceâ†’Dense) | Replaced by difficulty labels |
| YAML dispatch schema | Formal subagent spawn messages | Dispatch is informal via orchestrator/skills |
| `.templates/*.yaml` (v3) | YAML template files for nodes/contracts | `_templates/` folder is the standard |
| Fixed L0â€“L4 levels | Rigid 5-level hierarchy with fixed semantics | L0â€“LN with N = depth. Optional, no fixed semantics |
| `PENDING` / `IN_PROGRESS` status | Plain-text status markers | Emoji+text: â³`[TODO]`, ğŸ”„`[WIP]`, etc. |
| Auto-detection for plan-or-not | Agents deciding whether to plan | Human authority â€” human initiates planning |
| 4-slot magnitude scale | Slots: <<1, 1, 2, 3, 4+ | Replaced by 8-slot maximum system |

---

## Design Principles Summary

| Principle | Rule |
|-----------|------|
| **One protocol, two profiles** | System + Procedure share primitives, differ in which files exist |
| **Omit, don't N/A** | Optional files don't exist on disk â€” never fill with "N/A" |
| **Human authority** | Human initiates planning; agents don't decide whether to plan |
| **Slots, not time** | 8-slot maximum system; each slot â‰ˆ 1 hour AI-agent time |
| **Structure-first** | Show the tree, then explain the rules |
| **ADHD-readable** | Visual-first: tables, ASCII boxes, folder trees, no text walls |
| **Type-prefix folders** | `SP01_`/`PP01_` â€” plan type and creation order visible when collapsed |
| **Gate-enforced closure** | State Delta + Module Index registration mandatory â€” not recommendations, gate conditions |
| **Archival over deletion** | Completed plans move to `_completed/YYYY-QN/`, never deleted |
| **Provenance tracking** | Every plan has an `origin:`, every module has `modified_by_plans:` |
| **Infrastructure underscore** | `_overview.md`, `_completed/`, `_templates/`, `_tree.md`, `_state_deltas_archive.md` â€” underscore prefix = infrastructure files |
| **Convention + tooling** | Convention is the skeleton, `dream_mcp` is the muscle. Convention-only survives ~6 months; tooling extends to ~50 plans |
| **Recording + predicting** | State Deltas record history; dependency DAG enables impact prediction |
| **Structural vs temporal** | `depends_on:`/`blocks:` = structural (permanent). `ğŸš§ [BLOCKED:reason]` = temporal (transient) |
| **Source of truth in frontmatter** | `knowledge_gaps:`, `invalidated_by:`, `depends_on:` live in frontmatter. Prose is supplementary |
| **Omit-when-default** | `priority: normal` is default â€” omit it. Only write `priority: emergency` |

---

## Implementation Notes (Carry Forward)

These are concrete changes needed in skills, templates, agents, and modules that are **out of scope for this spec document** but must be tracked for implementation.

### Template & Skill Updates

| Item | What to Change | Priority |
|------|---------------|----------|
| `day-dream` skill | Update all template path references from `templates/` to `_templates/` | HIGH |
| `writing-templates` skill | Update location references and naming convention docs | HIGH |
| `dream-planning` skill | Update folder structure examples to show `SP01_`/`PP01_` prefixes, `_completed/YYYY-QN/`, `_tree.md`, dependency fields, invalidation protocol | HIGH |
| Compiled agent files | Update any `.agent.md` files that reference `templates/` paths | MEDIUM |
| `dream-planning` skill | Add `depends_on:` / `blocks:` / `knowledge_gaps:` / `priority:` to frontmatter examples | HIGH |
| `dream-planning` skill | Document invalidation protocol (WHO/WHERE/WHEN/HOW) | HIGH |
| `dream-planning` skill | Document Module Index gate condition | HIGH |

### Template File Changes

| Item | What to Change | Priority |
|------|---------------|----------|
| `overview.template.md` | Add `type:`, `origin:`, `start_at:`, `last_updated:` to frontmatter scaffold | HIGH |
| `overview.template.md` | Add `depends_on:`, `blocks:`, `knowledge_gaps:`, `priority:`, `invalidated_by:`, `invalidation_scope:`, `invalidation_date:` as commented optional fields | HIGH |
| `overview.template.md` (root) | Add `## Current Sprint`, `## Module Index` (with Knowledge Gaps column), `## State Deltas` sections. Add Priority and Depends On columns to Plans table | HIGH |
| `module_spec.template.md` | Add `last_updated:`, `modified_by_plans:`, and `knowledge_gaps:` to frontmatter scaffold | HIGH |
| Create `01_summary.template.md` | Procedure Plan merged summary template (referenced in v4.02 but template file may not exist) | HIGH |
| `80_implementation.template.md` | Update slot notation comment to reflect 8-slot scale (if not already done) | LOW |
| `simple.template.md` | Add `origin:` frontmatter | LOW |

### New Module

| Item | What to Change | Priority |
|------|---------------|----------|
| `dream_mcp` P0 walking skeleton | Build `dream status`, `dream tree`, `dream stale`. 3 commands, stdin/stdout, read-only (except `_tree.md` write). ~200 LOC. [KNOWN] | **P0** |
| `dream_mcp` P1 expansion | Build `dream validate`, `dream impact`, `dream history`, `dream archive`. 4 commands, adds DAG traversal and archival automation. [KNOWN] | P1 |
| `dream_mcp` Blueprint plan | Create SP plan for dream_mcp (Heavy magnitude, Blueprint tier). Phased delivery: P0 skeleton â†’ P1 expansion | **P0** |

### Directory & File Changes

| Item | What to Change | Priority |
|------|---------------|----------|
| Rename `templates/` â†’ `_templates/` | Physical directory rename in `.agent_plan/day_dream/`. 27+ references across skills, agents, and docs need updating | HIGH |
| Create `_state_deltas_archive.md` | Root-level infrastructure file for overflow State Delta entries. Header: `<!-- GENERATED â€” managed by dream_mcp -->` | When first overflow occurs |
| Restructure `_completed/` | Create `YYYY-QN/` sub-directories for existing archived plans | When next plan is archived |
| Update `_tree.md` header | Change to `<!-- GENERATED â€” run 'dream tree' to refresh -->` | HIGH |

### Convention Changes (Agent Behavior)

| Item | What to Change | Priority |
|------|---------------|----------|
| Root `_overview.md` write restriction | Only root MANAGER / `dream_mcp` writes to root `_overview.md`. Agents update own plan's `status:` frontmatter only | HIGH |
| Module Index gate enforcement | Agents self-enforce: new module â†’ register in root Module Index before marking phase DONE | HIGH |
| Invalidation reporting | Agents report invalidations at plan closure. Parent/orchestrator writes `invalidated_by:` to victim | HIGH |
| Priority signaling | `emergency` plans must set `blocks:` on resource-sharing plans. `dream status` surfaces emergency first | MEDIUM |
| `_tree.md` discipline | Agents NEVER hand-edit `_tree.md`. Defer all tree generation to `dream tree` | HIGH |
| Knowledge gaps in frontmatter | Agents add `knowledge_gaps:` to plan and module spec frontmatter as discovered. Remove when resolved | MEDIUM |

---

*End of DREAM v4.04 â€” Unified Planning System Specification*
