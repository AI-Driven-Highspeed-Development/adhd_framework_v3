# DREAM v3: Decomposition Rules for Engineering Atomic Modules

**Version:** 3.0  
**Status:** Standalone Specification  
**Updated:** January 2026

---

## 1. Overview

DREAM is a decomposition protocol for breaking complex work into atomic, parallelizable units. Nodes are **specifications** (not code) that describe what needs to be built. Agents **fulfill** nodes by creating or modifying artifacts.

**Key Changes from Previous Versions:**
- Split node files into `node.yaml` (routing) + `contract.yaml` (execution)
- Phases moved to dedicated `phases/` folder (not inside modules)
- Added Agent Protocol Card for LLM consumption
- Explicit subagent bootstrap protocol with MUST rules
- Terminology: agents "fulfill" WORKER nodes and "process" MANAGER nodes

---

## 2. Core Concepts

### 2.1 The Fractal Principle

Projects are recursive structures. Any node can be zoomed into for more detail, or zoomed out to see its context. A node is a **Plan** if it contains ambiguity; otherwise, it is a **Task** and must be fulfilled immediately.

### 2.2 Two Node Types

| Type | Role | Can Have Children? |
|------|------|-------------------|
| **MANAGER** | Processes children through lifecycle phases | Yes |
| **WORKER** | Fulfills specification, produces artifacts | No |

### 2.3 Level Hierarchy

| Level | Name | Scope | Duration | Container |
|-------|------|-------|----------|-----------|
| L0 | Portfolio | Multiple projects | Years | Folder + YAML |
| L1 | Project | Single product | Months | Folder + node.yaml |
| L2 | System | Module collection | Weeks | Folder + node.yaml |
| L3 | Module | Single responsibility | Days | `.md` file |
| L4 | Specification | Implementation detail | Hours | `.spec.md` file |

---

## 3. Physical Structure

### 3.1 Recommended Folder Layout

```
day_dream/
├── DREAM_AGENT_CARD.md               # Agent Protocol Card (REQUIRED)
│
├── my-project/                       # L1: Project
│   ├── node.yaml                     # L1 routing metadata
│   ├── contract.yaml                 # L1 delivery contract
│   ├── README.md                     # L1 human overview
│   │
│   ├── phases/                       # ⚠️ GENERATED by L1 MANAGER - READ ONLY
│   │   ├── P0-walking-skeleton.yaml  # Aggregated from children's phase_contributions
│   │   ├── P1-core-features.yaml
│   │   └── P2-polish.yaml
│   │
│   ├── combat-system/                # L2: System
│   │   ├── node.yaml                 # L2 routing metadata
│   │   ├── contract.yaml             # L2 integration contract
│   │   ├── README.md
│   │   │
│   │   ├── damage-calculator.md      # L3: Module spec
│   │   ├── damage-calculator.spec.md # L4: Implementation detail (optional)
│   │   ├── hitbox-detection.md       # L3: Module spec
│   │   └── hitbox-detection.spec.md  # L4: Implementation detail
│   │
│   └── dialog-system/                # L2: System
│       ├── node.yaml
│       ├── contract.yaml
│       └── conversation-engine.md    # L3: Module spec
│
└── state/                            # Machine-managed (DO NOT EDIT)
    ├── execution.json
    └── history.json
```

### 3.2 L4 Specification Files

L4 specs live alongside their L3 module as `{module-name}.spec.md`:

```
combat-system/
├── damage-calculator.md        # L3: What this module does
├── damage-calculator.spec.md   # L4: How to implement it
```

**L4 contains:**
- Algorithms
- Data structures
- Edge case handling
- Test scenarios

---

## 4. File Schemas

All file schemas are defined as templates. Copy and adapt for your project.

| File Type | Template Location | Purpose |
|-----------|------------------|----------|
| `node.yaml` | [.templates/node.template.yaml](.templates/node.template.yaml) | Routing metadata (~15 lines) |
| `contract.yaml` | [.templates/contract.template.yaml](.templates/contract.template.yaml) | Execution specification (~40 lines) |
| Phase definitions | [.templates/phase.template.yaml](.templates/phase.template.yaml) | Cross-cutting temporal scope |
| L3 Module | [.templates/module.template.md](.templates/module.template.md) | Module specification |
| L4 Specification | [.templates/spec.template.md](.templates/spec.template.md) | Implementation detail |

### 4.1 Quick Schema Summary

**node.yaml** (Routing - read first for decisions):
- `id`, `name`, `level`, `type` (MANAGER/WORKER)
- `status` (PENDING/IN_PROGRESS/BLOCKED/DONE)
- `magnitude` (Trivial/Light/Standard/Heavy/Epic)
- `modules` (for MANAGER: list of children)
- `depends_on` (blocking dependencies)
- `phase_contributions` (YOUR phase membership - parent aggregates into phases/*.yaml)
- `contract_file` (pointer to detailed spec)

**contract.yaml** (Execution - read when doing work):
- `inputs` (what the node needs)
- `outputs` (what the node produces)
- `constraints` (rules to follow)
- `acceptance` (definition of done)
- `agent_hints` (required reading, complexity class)

**phase.yaml** (MANAGER-generated aggregation - READ ONLY):
- `id`, `name`, `goal`
- `scope` (aggregated from children's `phase_contributions`)
- `difficulty_labels` (known/experimental/research counts)
- `integration_tests` (cross-module validation)

> **Note:** Children declare `phase_contributions` in their own `node.yaml`. Parent MANAGER aggregates into `phases/*.yaml` during INTEGRATE. This preserves sibling firewall.

---

## 5. Agent Orchestration Protocol

### 5.1 Bootstrap Sequence

When an agent is assigned to a node, it MUST execute this sequence:

```
1. READ  day_dream/DREAM_AGENT_CARD.md       (protocol rules)
2. READ  assigned node's node.yaml        (routing decision)
3. READ  assigned node's contract.yaml    (execution spec)
4. READ  parent's contract.yaml           (boundary check)
5. DECIDE  Am I WORKER or MANAGER?
6. EXECUTE  appropriate lifecycle
```

### 5.2 MANAGER Lifecycle (Process Children)

```
┌─────────────────────────────────────────────────────────────┐
│ DECOMPOSE                                                   │
│   • Verify all children have node.yaml + contract.yaml      │
│   • If missing, create them (or request human to create)    │
│   • Validate contracts are compatible with parent           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ DELEGATE                                                    │
│   • For each child where status == PENDING:                 │
│   • You MUST spawn a subagent for that child                │
│   • Pass: node path + DREAM_AGENT_CARD.md reference         │
│   • Max 5 parallel subagents                                │
│   • If cannot spawn, inform user to invoke manually         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ INTEGRATE (when all children DONE)                          │
│   • Merge child outputs                                     │
│   • Aggregate children's phase_contributions → phases/*.yaml│
│   • Validate against own contract.yaml acceptance criteria  │
│   • Resolve conflicts between sibling outputs               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ REPORT                                                      │
│   • Set own status = DONE                                   │
│   • Notify parent (or runner) of completion                 │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 WORKER Lifecycle (Fulfill Node)

```
┌─────────────────────────────────────────────────────────────┐
│ VALIDATE                                                    │
│   • Check magnitude != Epic (if Epic, refuse and escalate)  │
│   • Check all depends_on nodes are DONE                     │
│   • If BLOCKED, set status and exit                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ IMPLEMENT                                                   │
│   • Read contract.yaml inputs/outputs/constraints           │
│   • Read L4 .spec.md if exists                              │
│   • Create or modify artifacts (code, docs, data)           │
│   • DO NOT modify sibling nodes                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ VERIFY                                                      │
│   • Check all acceptance criteria in contract.yaml          │
│   • If any fail, document in node status and escalate       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ REPORT                                                      │
│   • Set status = DONE                                       │
│   • Notify parent of completion                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 Subagent Dispatch Format

When a MANAGER spawns a subagent:

```yaml
# Subagent dispatch message
action: SPAWN_WORKER
target_node: "combat-system/damage-calculator.md"
required_reading:
  - "day_dream/DREAM_AGENT_CARD.md"
  - "combat-system/contract.yaml"
permissions:
  read: [self, ancestors, project_codebase]
  write: [self]
on_complete: NOTIFY_PARENT
objectives:
  - Fulfill the damage-calculator.md node according to its contract.yaml
  - Check the actual implementation against acceptance criteria
```

### 5.5 State Transitions

```
PENDING ─────────────────────────────────────────► IN_PROGRESS
         "Agent claims node"                        │
                                                    │
              ┌─────────────────────────────────────┤
              │                                     │
              ▼                                     ▼
          BLOCKED                                 DONE
  "Dependency unavailable"              "Acceptance criteria met"
              │
              │ "Dependency resolved"
              │
              └──────────────────────────► IN_PROGRESS
```

---

## 6. Context Isolation Rules

### 6.1 Sibling Firewall

**Siblings NEVER communicate directly.** All cross-module coordination goes through the parent MANAGER's INTEGRATE phase.

### 6.2 Agent Visibility

| Scope | What Agent Can See |
|-------|-------------------|
| **Read** | Own node, all ancestors up to root, DREAM_AGENT_CARD.md |
| **Write** | Own node ONLY |
| **Sibling Metadata** | Yes (via parent's modules array) - status only |
| **Sibling Content** | NO |

### 6.3 Parallel Execution Safety

| Scenario | Parallel Safe? | Reason |
|----------|---------------|--------|
| Siblings with no ancestor writes | ✅ Yes | No race conditions |
| Siblings needing parent update | ❌ No | Sequential to prevent conflicts |
| Workers on different branches | ✅ Yes | No shared ancestors |

---

## 7. Magnitude and Routing

### 7.1 Magnitude Scale

| Magnitude | Action | Time Estimate |
|-----------|--------|---------------|
| Trivial | Execute immediately | 5-15 min |
| Light | Execute directly | 15-60 min |
| Standard | Execute directly | 1-4 hours |
| Heavy | Consider decomposition | 4h - 2 days |
| Epic | **MUST decompose** | 2+ days |

### 7.2 Complexity Classes

| Class | Name | Human Review Required? |
|-------|------|----------------------|
| A | Surface | No - auto-integrate |
| B | Isolated | Optional |
| C | Integrated | **Yes** |
| D | Dense | **Yes** |

### 7.3 Human vs AI Routing

| Route to HUMAN | Route to AI |
|----------------|-------------|
| Goal alignment ("is this right?") | Goal execution ("build this") |
| Acceptance testing | Unit/integration tests |
| Novel domain knowledge | Standard patterns |
| Subjective quality (UX, aesthetics) | Objective quality (lint, compile) |

---

## 8. Anti-Patterns Checklist

| Anti-Pattern | Correct Pattern |
|--------------|-----------------|
| Phase plans inside L3 modules | Use `phases/` folder at project level |
| Children editing phases/*.yaml | Declare `phase_contributions` in own node.yaml |
| Siblings communicating directly | Use parent MANAGER's INTEGRATE phase |
| Epic-magnitude WORKER nodes | Decompose into MANAGER with children |
| node.yaml with 50+ lines | Split into node.yaml + contract.yaml |
| MANAGER not spawning subagents | MUST spawn subagent for each PENDING child |
| Research items in P0 | Only [KNOWN] items in P0 |
| Agents reading sibling content | Agents read sibling STATUS only (via parent) |
| Skipping DREAM_AGENT_CARD.md | Always first read for any spawned agent |

---

## 9. Quick Reference

```
DREAM v3 Quick Reference
═══════════════════════════════════════════════════════════

LEVELS
  L0: Portfolio → L1: Project → L2: System → L3: Module → L4: Spec

FILES (per node)
  node.yaml     = Routing metadata (~15 lines)
  contract.yaml = Execution spec (~40 lines)
  .spec.md      = L4 implementation detail (optional)

NODE TYPES
  MANAGER = DECOMPOSE → DELEGATE → INTEGRATE → REPORT (process children)
  WORKER  = VALIDATE → IMPLEMENT → VERIFY → REPORT (fulfill node)

PHASES
  Declared in: each node's phase_contributions field
  Aggregated to: project/phases/*.yaml (by MANAGER during INTEGRATE)
  Children: READ ONLY access to phases/*.yaml

AGENT BOOTSTRAP (mandatory sequence)
  1. Read DREAM_AGENT_CARD.md
  2. Read node.yaml (routing)
  3. Read contract.yaml (execution)
  4. Read parent contract (boundaries)
  5. Follow lifecycle (MANAGER: process, WORKER: fulfill)

SIBLING FIREWALL
  Read:  Self + ancestors
  Write: Self only
  Parallel: OK if no shared ancestor writes

MAGNITUDE ACTIONS
  Trivial/Light/Standard = Execute directly
  Heavy = Consider decomposition
  Epic = MUST decompose

HUMAN REVIEW GATES
  Class A/B: Optional
  Class C/D: Required
```

---

## Appendix A: Migration from v2

| v2 Concept | v3 Equivalent |
|------------|---------------|
| Single node.yaml | Split to node.yaml + contract.yaml |
| Phases in L3 frontmatter | Separate phases/ folder |
| Implicit L4 embedding | Explicit .spec.md files |
| "Execute" terminology | "Fulfill" (WORKER) / "Process" (MANAGER) |
| Inline schemas | Template files in templates/ folder |
| agent_bootstrap in node | agent_hints in contract.yaml |

---

*End of DREAM v3 Specification*
