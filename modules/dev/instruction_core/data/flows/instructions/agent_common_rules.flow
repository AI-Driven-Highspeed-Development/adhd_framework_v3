# Agent Common Rules — Production Flow Source
#
# Compiles to instructions/agent_common_rules.instructions.md
# Frontmatter metadata lives in the sidecar agent_common_rules.yaml
#
# Source of truth: instruction_core/data/instructions/agents/agent_common_rules.instructions.md
#
# This is a documentation/authoring-guidance file, not an agent file.
# No shared _lib/ fragments used — the canonical rule templates documented
# here are the SOURCE for what _lib/ fragments contain, but rendered in
# fenced code blocks for reference, which differs from agent composition.

# =============================================================================
# Title & Introduction
# =============================================================================

@title
|<<<
# Agent Common Rules

This instruction file provides **authoring-time guidance** for creating and maintaining ADHD Framework agents. It defines the semantic purpose of each section and provides canonical templates for common rules.
>>>|.

# =============================================================================
# Section Semantics
# =============================================================================

@section_semantics
|<<<
## Section Semantics

| Section | Purpose | Mental Model | Format |
|---------|---------|--------------|--------|
| `<stopping_rules>` | Conditions that trigger IMMEDIATE ABORT | Circuit breaker | "STOP IF..." / "NEVER..." |
| `<critical_rules>` | Persistent behavioral norms that shape HOW the agent works | Operating parameters | "ALWAYS..." / methodology constraints |
| `<core_philosophy>` | WHY the agent behaves this way—identity and values | Agent DNA | Principles, not rules |

**Key Principle**: If a rule is a halt trigger, put it in `<stopping_rules>` ONLY. If it's a methodology norm, put it in `<critical_rules>` ONLY. Never duplicate the same rule in both sections.
>>>|.

# =============================================================================
# Canonical Rule Templates
# =============================================================================
# These templates document the authoritative text for each shared rule.
# They are rendered inside fenced code blocks in the compiled output
# (unlike _lib/ fragments which produce raw text for agent composition).

@canonical_templates
|<<<
## Canonical Rule Templates

### 1. Agent File Edit Restriction
**Use in**: All agents EXCEPT HyperAgentSmith
**Section**: `<stopping_rules>`

```
NEVER edit `.agent.md`, `.prompt.md`, or `.instructions.md` files. These are managed EXCLUSIVELY by HyperAgentSmith.
```

### 2. User "No Edit" Override
**Use in**: Agents with edit tools (HyperArch, HyperAgentSmith, HyperIQGuard, HyperDream)
**Section**: `<stopping_rules>`

```
If the user says "no edit", "discussion only", "don't edit", "read only", or similar phrases: engage in discussion and provide guidance, but NEVER create, edit, or delete any file or folder. Also, DO NOT output full implementation code blocks in chat; small snippets to illustrate ideas are fine, but no code dumps.
```

### 3. Stopping Rules Persistence Meta-Rule
**Use in**: All agents
**Section**: `<critical_rules>`

```
- **Stopping Rules Bind**: All `<stopping_rules>` are HARD CONSTRAINTS that persist across the entire task. Check them BEFORE each tool invocation, not just at task start.
```

### 4. Truthfulness Principle
**Use in**: All agents
**Section**: `<core_philosophy>`

```
**Truthfulness over Agreeableness**: Prioritize facts and accuracy over being agreeable. Politely correct misconceptions rather than validating them. Never say "you're absolutely right" unless it is objectively true.
```
>>>|.

# =============================================================================
# File Edit Guard — Clone Detection
# =============================================================================

@file_edit_guard
|<<<
## File Edit Guard — Clone Detection

Before editing any `.md` file (agents, instructions, prompts, skills, templates, or any context files):

1. **Read the first 10 lines** of the target file
2. **Check for ADHD-MANAGED header** — look for:
   - `<!-- ADHD-MANAGED` or `# ADHD-MANAGED` or similar markers
   - `Source:` line indicating the canonical source path
3. **If header found:**
   - Extract the source path from the header
   - **Edit the SOURCE file instead** — do NOT edit the clone
   - Report: "Redirected edit from clone `{clone_path}` to source `{source_path}`"
4. **If no header:** Proceed with edit normally

**Common clone locations** (always check these):
- `.github/agents/` → source in `modules/dev/instruction_core/data/flows/agents/` (compiled from `.flow`)
- `.github/instructions/` → source in `modules/dev/instruction_core/data/instructions/`
- `.github/skills/` → source in `modules/dev/instruction_core/data/skills/`
- `.agent_plan/day_dream/_templates/` → source in `modules/dev/instruction_core/data/.agent_plan/day_dream/_templates/`

After editing source files, run `adhd r -f` to sync changes to clones.
>>>|.

# =============================================================================
# De-duplication Guidelines
# =============================================================================

@deduplication
|<<<
## De-duplication Guidelines

When the same constraint appears in both `<stopping_rules>` and `<critical_rules>`:

1. **Ask**: Is this a HALT trigger or a METHODOLOGY norm?
2. **If halt trigger**: Keep in `<stopping_rules>`, rephrase in `<critical_rules>` to describe the methodology (not the halt condition)
3. **Example**:
   - ❌ stopping_rules: "STOP if >5 files" + critical_rules: "Scope Limit: 1-5 files"
   - ✅ stopping_rules: "STOP if >5 files" + critical_rules: "Scope Discipline: Focus on targeted, file-by-file analysis"
>>>|.

# =============================================================================
# Why Duplication Exists
# =============================================================================

@why_duplication
|<<<
## Why Duplication Exists (And When It's OK)

VS Code Custom Agents load each `.agent.md` file **in isolation**. There is no runtime import mechanism. Therefore:

- **Safety-critical rules MUST be in each agent's file** (not just referenced globally)
- This instruction file provides **authoring consistency**, not runtime injection
- Duplication across agents is architecturally correct; duplication WITHIN an agent is the problem
>>>|.

# =============================================================================
# Entry Point
# =============================================================================

@out
|$title
|<<
>>|$section_semantics
|<<
>>|$canonical_templates
|<<
>>|$file_edit_guard
|<<
>>|$deduplication
|<<
>>|$why_duplication
|.
